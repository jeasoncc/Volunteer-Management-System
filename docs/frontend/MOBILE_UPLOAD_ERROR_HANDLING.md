# 手机上传错误处理说明

## 📱 令牌有效期

- **有效期**: 10 分钟
- **生成位置**: 电脑端点击"手机上传"按钮
- **使用方式**: 手机扫描二维码或打开链接

## ⚠️ 错误类型和提示

### 1. 令牌过期
**触发条件**: 超过 10 分钟未上传

**后端返回**:
```json
{
  "success": false,
  "message": "令牌已过期，请重新扫码"
}
```

**前端显示**:
```
⏰ 上传链接已过期

请返回电脑端重新生成二维码
```

### 2. 令牌无效
**触发条件**: 
- 令牌不存在
- 令牌格式错误
- URL 中没有 token 参数

**后端返回**:
```json
{
  "success": false,
  "message": "令牌无效或已过期"
}
```

**前端显示**:
```
❌ 上传链接无效

请返回电脑端重新生成二维码
```

### 3. 文件类型错误
**触发条件**: 上传非图片文件

**前端显示**:
```
请选择图片文件
```

### 4. 文件大小超限
**触发条件**: 文件大小 > 5MB

**前端显示**:
```
图片大小不能超过 5MB
```

## 🔧 错误处理逻辑

### 前端代码
```typescript
const uploadFile = async (file: File) => {
  try {
    const response = await fetch(apiUrl, {
      method: "POST",
      body: formData,
    });

    const data = await response.json();

    if (!response.ok) {
      const errorMsg = data.message || "上传失败";
      
      // 检查是否是令牌相关错误
      if (errorMsg.includes("令牌") || errorMsg.includes("token")) {
        if (errorMsg.includes("过期")) {
          throw new Error("⏰ 上传链接已过期\n\n请返回电脑端重新生成二维码");
        } else if (errorMsg.includes("无效")) {
          throw new Error("❌ 上传链接无效\n\n请返回电脑端重新生成二维码");
        }
      }
      
      throw new Error(errorMsg);
    }

    // 上传成功
    setUploaded(true);
    toast.success("上传成功！");
  } catch (error: any) {
    toast.error(error.message);
    
    // 如果是令牌错误，清除预览
    if (error.message.includes("过期") || 
        error.message.includes("无效") || 
        error.message.includes("令牌")) {
      setPreview(undefined);
    }
  }
};
```

### 后端代码
```typescript
// 验证令牌
const tokenData = uploadTokens.get(token);
if (!tokenData) {
  throw new ValidationError('令牌无效或已过期');
}

// 检查令牌是否过期（10分钟）
const expireTime = 10 * 60 * 1000;
if (Date.now() - tokenData.createdAt > expireTime) {
  uploadTokens.delete(token);
  throw new ValidationError('令牌已过期，请重新扫码');
}
```

## 📋 用户操作流程

### 正常流程
1. 电脑端：点击"手机上传"按钮
2. 系统：生成二维码（10分钟有效）
3. 手机端：扫描二维码
4. 手机端：选择照片或拍照
5. 手机端：上传成功
6. 电脑端：自动接收照片

### 令牌过期流程
1. 电脑端：点击"手机上传"按钮
2. 系统：生成二维码
3. **等待超过 10 分钟**
4. 手机端：扫描二维码
5. 手机端：选择照片上传
6. **系统提示：⏰ 上传链接已过期**
7. 用户：返回电脑端重新生成二维码

### 令牌无效流程
1. 手机端：打开错误的链接或过期链接
2. **系统提示：❌ 上传链接无效**
3. 用户：返回电脑端重新生成二维码

## 💡 用户提示

### 页面加载时（无 token）
```
链接无效或已过期

上传链接可能已过期或无效

💡 解决方法：
• 返回电脑端重新生成二维码
• 确保在二维码生成后 10 分钟内扫描
• 检查网络连接是否正常
```

### 上传时（令牌过期）
```
Toast 提示：
⏰ 上传链接已过期

请返回电脑端重新生成二维码
```

### 上传时（令牌无效）
```
Toast 提示：
❌ 上传链接无效

请返回电脑端重新生成二维码
```

## 🎯 最佳实践

### 用户建议
1. **及时上传**: 生成二维码后 10 分钟内完成上传
2. **检查网络**: 确保手机和电脑在同一 WiFi
3. **重新生成**: 如果过期，返回电脑端重新生成

### 开发建议
1. **清晰提示**: 区分"过期"和"无效"两种情况
2. **友好界面**: 使用图标和颜色增强视觉效果
3. **自动清理**: 清除过期令牌，释放内存
4. **日志记录**: 记录上传失败原因，便于排查

## 🔍 调试信息

### 检查令牌状态
```bash
# 查看后端日志
cd apps/api
bun run dev

# 生成令牌时会显示
🔑 生成手机上传令牌: abc123...

# 上传成功时会显示
📱 手机上传成功: mobile-xxx.jpg (123.45 KB)
```

### 测试令牌过期
1. 修改后端代码，将过期时间改为 1 分钟：
```typescript
const expireTime = 1 * 60 * 1000; // 1分钟
```

2. 生成二维码
3. 等待 1 分钟后上传
4. 应该看到"令牌已过期"提示

## 📊 错误统计

| 错误类型 | HTTP 状态码 | 错误消息 | 用户操作 |
|---------|------------|---------|---------|
| 令牌过期 | 400 | 令牌已过期，请重新扫码 | 重新生成二维码 |
| 令牌无效 | 400 | 令牌无效或已过期 | 重新生成二维码 |
| 文件类型错误 | 400 | 只支持 JPG、PNG、WEBP 格式 | 选择正确格式 |
| 文件过大 | 400 | 文件大小不能超过 5MB | 压缩图片 |
| 网络错误 | - | 上传失败，请重试 | 检查网络 |

---

**更新时间**: 2025-11-26
**状态**: ✅ 错误处理已优化，提示信息清晰明确
