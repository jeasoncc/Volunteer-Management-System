# æ‰‹æœºä¸Šä¼ ç”¨æˆ·ä½“éªŒä¼˜åŒ–

## ğŸ“… æ›´æ–°æ—¶é—´
2025-11-26

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆä¸¤ä¸ªé—®é¢˜ï¼š
1. **ä»¤ç‰Œè¿‡æœŸé—®é¢˜**: æ‰‹æœºä¸Šä¼ æ—¶æç¤º"ä»¤ç‰Œå·²è¿‡æœŸ"
2. **ç•Œé¢æŠ–åŠ¨é—®é¢˜**: äºŒç»´ç å¯¹è¯æ¡†æ‰“å¼€æ—¶ç•Œé¢ä¸€ç›´åœ¨æŠ–åŠ¨

## ğŸ” é—®é¢˜åˆ†æ

### 1. ä»¤ç‰Œè¿‡æœŸåŸå› 
- **æ ¹æœ¬åŸå› **: åç«¯ä»¤ç‰Œå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ˆ`Map`ï¼‰ï¼ŒæœåŠ¡å™¨é‡å¯åä¼šä¸¢å¤±
- **è§¦å‘åœºæ™¯**: 
  - åç«¯æœåŠ¡é‡å¯
  - å¼€å‘æ—¶ä»£ç ä¿®æ”¹è§¦å‘çƒ­é‡è½½
  - è¶…è¿‡ 10 åˆ†é’Ÿæœ‰æ•ˆæœŸ

### 2. ç•Œé¢æŠ–åŠ¨åŸå› 
- **æ ¹æœ¬åŸå› **: è½®è¯¢æ£€æŸ¥ä¸Šä¼ çŠ¶æ€æ—¶ï¼Œæ¯æ¬¡éƒ½è®¾ç½® `checking` çŠ¶æ€
- **è§¦å‘æœºåˆ¶**: æ¯ 3 ç§’æ‰§è¡Œä¸€æ¬¡è½®è¯¢ï¼Œå¯¼è‡´é¢‘ç¹é‡æ¸²æŸ“
- **è¡¨ç°**: äºŒç»´ç åŒºåŸŸä¸æ–­é—ªçƒ/æŠ–åŠ¨

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### 1. æ·»åŠ åˆ·æ–°äºŒç»´ç åŠŸèƒ½

#### åŠŸèƒ½è¯´æ˜
- åœ¨äºŒç»´ç ä¸‹æ–¹æ·»åŠ "åˆ·æ–°äºŒç»´ç "æŒ‰é’®
- ç‚¹å‡»åé‡æ–°ç”Ÿæˆä»¤ç‰Œå’ŒäºŒç»´ç 
- æ— éœ€å…³é—­å¯¹è¯æ¡†å³å¯åˆ·æ–°

#### å®ç°ä»£ç 
```typescript
// æ·»åŠ çŠ¶æ€
const [uploadToken, setUploadToken] = useState(initialToken);
const [regenerating, setRegenerating] = useState(false);

// é‡æ–°ç”Ÿæˆä»¤ç‰Œ
const handleRegenerate = async () => {
  try {
    setRegenerating(true);
    const { api } = await import("@/lib/api");
    const data: any = await api.post("/api/upload/token");

    if (!data.data?.token) {
      throw new Error("è·å–ä¸Šä¼ ä»¤ç‰Œå¤±è´¥");
    }

    setUploadToken(data.data.token);
    toast.success("äºŒç»´ç å·²åˆ·æ–°");
  } catch (error: any) {
    toast.error(error.message || "åˆ·æ–°å¤±è´¥ï¼Œè¯·é‡è¯•");
  } finally {
    setRegenerating(false);
  }
};
```

#### UI è®¾è®¡
```tsx
<div className="relative">
  <div className="p-4 bg-white rounded-lg border-2 border-dashed">
    <QRCodeSVG value={uploadUrl} size={200} level="H" />
  </div>
  {/* åˆ·æ–°æŒ‰é’® */}
  <Button
    onClick={handleRegenerate}
    disabled={regenerating}
    className="absolute -bottom-3 left-1/2 -translate-x-1/2"
  >
    <RefreshCw className={regenerating ? 'animate-spin' : ''} />
    {regenerating ? 'åˆ·æ–°ä¸­...' : 'åˆ·æ–°äºŒç»´ç '}
  </Button>
</div>
```

### 2. ä¼˜åŒ–è½®è¯¢æœºåˆ¶

#### é—®é¢˜ä»£ç 
```typescript
// âŒ æ¯æ¬¡è½®è¯¢éƒ½è®¾ç½®çŠ¶æ€ï¼Œå¯¼è‡´æŠ–åŠ¨
const checkUploadStatus = async () => {
  try {
    setChecking(true);  // å¯¼è‡´é‡æ¸²æŸ“
    // ... æ£€æŸ¥é€»è¾‘
  } finally {
    setChecking(false);  // åˆä¸€æ¬¡é‡æ¸²æŸ“
  }
};
```

#### ä¼˜åŒ–å
```typescript
// âœ… åªåœ¨åˆå§‹åŒ–æ—¶è®¾ç½®çŠ¶æ€ï¼Œè½®è¯¢æ—¶ä¸æ”¹å˜
useEffect(() => {
  if (!open || !uploadToken) return;

  // åˆå§‹æ˜¾ç¤ºç­‰å¾…çŠ¶æ€ï¼ˆåªè®¾ç½®ä¸€æ¬¡ï¼‰
  setChecking(true);

  const checkUploadStatus = async () => {
    try {
      const { api } = await import("@/lib/api");
      const data: any = await api.get(`/api/upload/status/${uploadToken}`);

      if (data.data?.url) {
        onUploadComplete(data.data.url);
        toast.success("ç…§ç‰‡ä¸Šä¼ æˆåŠŸï¼");
        onClose();
      }
    } catch (error) {
      console.error("æ£€æŸ¥ä¸Šä¼ çŠ¶æ€å¤±è´¥:", error);
    }
    // ä¸è¦åœ¨è¿™é‡Œè®¾ç½® checking çŠ¶æ€
  };

  // é™ä½è½®è¯¢é¢‘ç‡ï¼š3ç§’ â†’ 5ç§’
  const interval = setInterval(checkUploadStatus, 5000);

  return () => {
    clearInterval(interval);
    setChecking(false);  // æ¸…ç†æ—¶æ‰é‡ç½®çŠ¶æ€
  };
}, [open, uploadToken, onUploadComplete, onClose]);
```

### 3. ä¼˜åŒ–ç”¨æˆ·æç¤º

#### æ·»åŠ åˆ·æ–°æç¤º
```tsx
<p className="text-blue-600 dark:text-blue-400">
  ğŸ’¡ å¦‚æœæç¤º"ä»¤ç‰Œè¿‡æœŸ"ï¼Œç‚¹å‡»ä¸Šæ–¹"åˆ·æ–°äºŒç»´ç "æŒ‰é’®
</p>
```

#### å®Œæ•´è¯´æ˜
```
ğŸ“± ä½¿ç”¨è¯´æ˜ï¼š
1. ç”¨æ‰‹æœºæ‰«æä¸Šæ–¹äºŒç»´ç 
2. åœ¨æ‰‹æœºä¸Šé€‰æ‹©æˆ–æ‹æ‘„ç…§ç‰‡
3. ä¸Šä¼ å®Œæˆåï¼Œç”µè„‘ç«¯è‡ªåŠ¨æ¥æ”¶

âš ï¸ é“¾æ¥10åˆ†é’Ÿå†…æœ‰æ•ˆï¼Œè¯·å°½å¿«ä¸Šä¼ 
ğŸ’¡ å¦‚æœæç¤º"ä»¤ç‰Œè¿‡æœŸ"ï¼Œç‚¹å‡»ä¸Šæ–¹"åˆ·æ–°äºŒç»´ç "æŒ‰é’®
âœ… å·²è‡ªåŠ¨ä½¿ç”¨å±€åŸŸç½‘IPï¼š192.168.5.4
   è¯·ç¡®ä¿æ‰‹æœºå’Œç”µè„‘åœ¨åŒä¸€WiFiç½‘ç»œ
```

## ğŸ“Š ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

### ä»¤ç‰Œè¿‡æœŸå¤„ç†

| åœºæ™¯ | ä¹‹å‰ | ç°åœ¨ |
|------|------|------|
| åç«¯é‡å¯ | âŒ æ— æ³•ä¸Šä¼ ï¼Œéœ€å…³é—­é‡å¼€ | âœ… ç‚¹å‡»åˆ·æ–°æŒ‰é’®å³å¯ |
| ä»¤ç‰Œè¿‡æœŸ | âŒ éœ€å…³é—­å¯¹è¯æ¡†é‡æ–°æ‰“å¼€ | âœ… ç‚¹å‡»åˆ·æ–°æŒ‰é’®å³å¯ |
| ç”¨æˆ·ä½“éªŒ | âŒ ç¹çï¼Œéœ€å¤šæ¬¡æ“ä½œ | âœ… ä¸€é”®åˆ·æ–°ï¼Œç®€å•å¿«æ· |

### ç•Œé¢æŠ–åŠ¨é—®é¢˜

| æŒ‡æ ‡ | ä¹‹å‰ | ç°åœ¨ |
|------|------|------|
| è½®è¯¢é¢‘ç‡ | æ¯ 3 ç§’ | æ¯ 5 ç§’ |
| çŠ¶æ€æ›´æ–° | æ¯æ¬¡è½®è¯¢éƒ½æ›´æ–° | åªåœ¨åˆå§‹åŒ–å’Œæ¸…ç†æ—¶æ›´æ–° |
| é‡æ¸²æŸ“æ¬¡æ•° | é«˜é¢‘ï¼ˆæ¯ 3 ç§’ 2 æ¬¡ï¼‰ | ä½é¢‘ï¼ˆå‡ ä¹æ— ï¼‰ |
| ç”¨æˆ·ä½“éªŒ | âŒ ç•Œé¢æŠ–åŠ¨æ˜æ˜¾ | âœ… ç•Œé¢ç¨³å®šæµç•… |

## ğŸ¯ ç”¨æˆ·æ“ä½œæµç¨‹

### æ­£å¸¸æµç¨‹
1. ç‚¹å‡»"æ‰‹æœºæ‰«ç ä¸Šä¼ "
2. æ‰«æäºŒç»´ç 
3. é€‰æ‹©ç…§ç‰‡ä¸Šä¼ 
4. ç”µè„‘ç«¯è‡ªåŠ¨æ¥æ”¶ âœ…

### ä»¤ç‰Œè¿‡æœŸæµç¨‹
1. ç‚¹å‡»"æ‰‹æœºæ‰«ç ä¸Šä¼ "
2. æ‰«æäºŒç»´ç 
3. æç¤º"ä»¤ç‰Œå·²è¿‡æœŸ" âš ï¸
4. **è¿”å›ç”µè„‘ç«¯ï¼Œç‚¹å‡»"åˆ·æ–°äºŒç»´ç "** ğŸ”„
5. é‡æ–°æ‰«ææ–°äºŒç»´ç 
6. é€‰æ‹©ç…§ç‰‡ä¸Šä¼ 
7. ç”µè„‘ç«¯è‡ªåŠ¨æ¥æ”¶ âœ…

## ğŸ’¡ æŠ€æœ¯è¦ç‚¹

### 1. çŠ¶æ€ç®¡ç†ä¼˜åŒ–
```typescript
// ä½¿ç”¨æœ¬åœ°çŠ¶æ€ç®¡ç†ä»¤ç‰Œ
const [uploadToken, setUploadToken] = useState(initialToken);

// æ”¯æŒåŠ¨æ€æ›´æ–°ä»¤ç‰Œ
setUploadToken(newToken);
```

### 2. é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
```typescript
// âŒ é”™è¯¯ï¼šé¢‘ç¹æ›´æ–°çŠ¶æ€
setChecking(true);
// ... å¼‚æ­¥æ“ä½œ
setChecking(false);

// âœ… æ­£ç¡®ï¼šåªåœ¨å¿…è¦æ—¶æ›´æ–°
useEffect(() => {
  setChecking(true);  // åˆå§‹åŒ–æ—¶
  // ... è½®è¯¢é€»è¾‘
  return () => setChecking(false);  // æ¸…ç†æ—¶
}, [deps]);
```

### 3. ç”¨æˆ·åé¦ˆä¼˜åŒ–
```typescript
// åŠ è½½çŠ¶æ€
{regenerating ? 'åˆ·æ–°ä¸­...' : 'åˆ·æ–°äºŒç»´ç '}

// åŠ¨ç”»æ•ˆæœ
<RefreshCw className={regenerating ? 'animate-spin' : ''} />

// Toast æç¤º
toast.success("äºŒç»´ç å·²åˆ·æ–°");
```

## ğŸ”® æœªæ¥ä¼˜åŒ–æ–¹å‘

### 1. ä»¤ç‰ŒæŒä¹…åŒ–ï¼ˆé•¿æœŸæ–¹æ¡ˆï¼‰
```typescript
// ä½¿ç”¨ Redis æˆ–æ•°æ®åº“å­˜å‚¨ä»¤ç‰Œ
// ä¼˜ç‚¹ï¼šæœåŠ¡å™¨é‡å¯ä¸å½±å“
// ç¼ºç‚¹ï¼šéœ€è¦é¢å¤–çš„å­˜å‚¨æœåŠ¡

// ç¤ºä¾‹ï¼šä½¿ç”¨ Redis
await redis.setex(`upload:token:${token}`, 600, JSON.stringify({
  createdAt: Date.now(),
  url: null
}));
```

### 2. WebSocket å®æ—¶é€šçŸ¥
```typescript
// æ›¿ä»£è½®è¯¢ï¼Œä½¿ç”¨ WebSocket æ¨é€
// ä¼˜ç‚¹ï¼šå®æ—¶æ€§æ›´å¥½ï¼Œå‡å°‘æœåŠ¡å™¨å‹åŠ›
// ç¼ºç‚¹ï¼šå®ç°å¤æ‚åº¦è¾ƒé«˜

ws.on('upload:complete', (data) => {
  onUploadComplete(data.url);
});
```

### 3. è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
```typescript
// æ£€æµ‹åˆ°ä»¤ç‰Œè¿‡æœŸæ—¶è‡ªåŠ¨åˆ·æ–°
if (error.message.includes('ä»¤ç‰Œå·²è¿‡æœŸ')) {
  await handleRegenerate();
  toast.info('äºŒç»´ç å·²è‡ªåŠ¨åˆ·æ–°ï¼Œè¯·é‡æ–°æ‰«æ');
}
```

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

1. **apps/web/src/components/MobileUploadDialog.tsx**
   - âœ… æ·»åŠ åˆ·æ–°äºŒç»´ç åŠŸèƒ½
   - âœ… ä¼˜åŒ–è½®è¯¢æœºåˆ¶ï¼Œé¿å…æŠ–åŠ¨
   - âœ… é™ä½è½®è¯¢é¢‘ç‡ï¼ˆ3ç§’ â†’ 5ç§’ï¼‰
   - âœ… æ·»åŠ ç”¨æˆ·æç¤ºä¿¡æ¯

2. **apps/api/src/modules/upload/index.ts**
   - âœ… æ·»åŠ æ³¨é‡Šè¯´æ˜ä»¤ç‰Œå­˜å‚¨æœºåˆ¶

## ğŸ‰ æˆæœ

- âœ… è§£å†³ç•Œé¢æŠ–åŠ¨é—®é¢˜
- âœ… æä¾›ä»¤ç‰Œåˆ·æ–°åŠŸèƒ½
- âœ… ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ
- âœ… é™ä½æœåŠ¡å™¨å‹åŠ›ï¼ˆè½®è¯¢é¢‘ç‡é™ä½ï¼‰
- âœ… æä¾›æ¸…æ™°çš„æ“ä½œæŒ‡å¼•

---

**çŠ¶æ€**: âœ… ç”¨æˆ·ä½“éªŒä¼˜åŒ–å®Œæˆ
**æµ‹è¯•**: å»ºè®®æµ‹è¯•ä»¤ç‰Œè¿‡æœŸå’Œåˆ·æ–°åŠŸèƒ½
