# é‡å¤å‘é€è®¡æ•°ä¿®å¤

## é—®é¢˜æè¿°

åœ¨ä½¿ç”¨"ä¸å‹ç¼©é‡è¯•"åŠŸèƒ½æ—¶ï¼Œå‘ç°æ¯ä¸ªç”¨æˆ·è¢«è®¡æ•°ä¸¤æ¬¡ï¼š

### æ—¥å¿—è¡¨ç°

```
[17:55:01] ğŸ“¤ å‘é€: æ¨ç§€æ• (LZ-V-4916136)
[17:55:01] ğŸ“¤ å‘é€: æ¨ç§€æ• (LZ-V-4916136)  â† é‡å¤ï¼
[17:55:01] ğŸ“¤ å‘é€: æ—ç›¸ç¾¤ (LZ-V-2436418)
[17:55:01] ğŸ“¤ å‘é€: æ—ç›¸ç¾¤ (LZ-V-2436418)  â† é‡å¤ï¼
```

### ç•Œé¢è¡¨ç°

```
å·²å‘é€ 16 / 16 å·²å‘é€  â† å®é™…åªæœ‰ 8 ä¸ªç”¨æˆ·
```

## é—®é¢˜åŸå› 

åœ¨ `retryFailedUsersWithoutCompression` æ–¹æ³•ä¸­ï¼Œå­˜åœ¨é‡å¤è®¡æ•°ï¼š

```typescript
// ç¬¬ 521 è¡Œï¼šæ‰‹åŠ¨è°ƒç”¨ incrementSent
syncProgressManager.incrementSent(user.lotusId!, user.name)

// ç¬¬ 524 è¡Œï¼šè°ƒç”¨ sendAddUserCommand
if (this.sendAddUserCommand(command, user)) {
  // sendAddUserCommand å†…éƒ¨ä¹Ÿä¼šè°ƒç”¨ incrementSentï¼ˆç¬¬ 70 è¡Œï¼‰
  // å¯¼è‡´é‡å¤è®¡æ•°ï¼
}
```

### è°ƒç”¨é“¾

```
retryFailedUsersWithoutCompression
  â”œâ”€ incrementSent()  â† ç¬¬ä¸€æ¬¡è®¡æ•°
  â””â”€ sendAddUserCommand()
       â””â”€ incrementSent()  â† ç¬¬äºŒæ¬¡è®¡æ•°ï¼ˆé‡å¤ï¼ï¼‰
```

## è§£å†³æ–¹æ¡ˆ

åˆ é™¤æ‰‹åŠ¨è°ƒç”¨çš„ `incrementSent`ï¼Œå› ä¸º `sendAddUserCommand` å†…éƒ¨å·²ç»ä¼šè°ƒç”¨ï¼š

```typescript
// ä¿®æ”¹å‰
logger.info(`ğŸ“‹ ä¸‹å‘åŸå§‹ç…§ç‰‡å‘½ä»¤: ${user.name}(${user.lotusId})`)
syncProgressManager.incrementSent(user.lotusId!, user.name)  // â† åˆ é™¤è¿™è¡Œ

// å‘é€å‘½ä»¤
if (this.sendAddUserCommand(command, user)) {
  successCount++
}

// ä¿®æ”¹å
logger.info(`ğŸ“‹ ä¸‹å‘åŸå§‹ç…§ç‰‡å‘½ä»¤: ${user.name}(${user.lotusId})`)
// æ³¨æ„ï¼šä¸è¦åœ¨è¿™é‡Œè°ƒç”¨ incrementSentï¼Œå› ä¸º sendAddUserCommand å†…éƒ¨ä¼šè°ƒç”¨

// å‘é€å‘½ä»¤
if (this.sendAddUserCommand(command, user)) {
  successCount++
}
```

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

```
[17:55:01] å¼€å§‹åŒæ­¥ï¼Œå…± 8 ä¸ªä¹‰å·¥
[17:55:01] ğŸ“¤ å‘é€: æ¨ç§€æ• (LZ-V-4916136)
[17:55:01] ğŸ“¤ å‘é€: æ¨ç§€æ• (LZ-V-4916136)  â† é‡å¤
...
å·²å‘é€ 16 / 16 å·²å‘é€  â† é”™è¯¯
```

### ä¿®å¤å

```
[17:55:01] å¼€å§‹åŒæ­¥ï¼Œå…± 8 ä¸ªä¹‰å·¥
[17:55:01] ğŸ“¤ å‘é€: æ¨ç§€æ• (LZ-V-4916136)  â† åªå‘é€ä¸€æ¬¡
...
å·²å‘é€ 8 / 8 å·²å‘é€  â† æ­£ç¡®
```

## ç›¸å…³ä»£ç 

### æ–‡ä»¶ä½ç½®

`apps/api/src/modules/ws/service.ts`

### ä¿®æ”¹çš„æ–¹æ³•

- `retryFailedUsersWithoutCompression` - ä¸å‹ç¼©é‡è¯•å¤±è´¥ç”¨æˆ·

### ç›¸å…³æ–¹æ³•

- `sendAddUserCommand` - å‘é€æ·»åŠ ç”¨æˆ·å‘½ä»¤ï¼ˆå†…éƒ¨ä¼šè°ƒç”¨ incrementSentï¼‰
- `incrementSent` - è®°å½•å·²å‘é€è®¡æ•°

## æµ‹è¯•å»ºè®®

1. é‡å¯ API æœåŠ¡
2. åŒæ­¥ä¸€äº›ç”¨æˆ·ï¼Œè®©éƒ¨åˆ†å¤±è´¥
3. ä½¿ç”¨"ä¸å‹ç¼©ä¸‹å‘"é‡è¯•å¤±è´¥çš„ç”¨æˆ·
4. è§‚å¯Ÿæ—¥å¿—å’Œç•Œé¢ï¼š
   - æ¯ä¸ªç”¨æˆ·åªåº”è¯¥æœ‰ä¸€æ¡"ğŸ“¤ å‘é€"æ—¥å¿—
   - "å·²å‘é€"è®¡æ•°åº”è¯¥ç­‰äºå®é™…ç”¨æˆ·æ•°

## å…¶ä»–é‡è¯•æ–¹æ³•

æ£€æŸ¥äº†å…¶ä»–é‡è¯•æ–¹æ³•ï¼Œæ²¡æœ‰å‘ç°ç±»ä¼¼é—®é¢˜ï¼š
- `retryFailedUsers` - æ­£å¸¸é‡è¯•ï¼ˆä½¿ç”¨ syncAllUsersï¼‰
- `retryFailedUsersWithBase64` - Base64 é‡è¯•ï¼ˆä½¿ç”¨ syncAllUsersï¼‰

è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯è°ƒç”¨ `syncAllUsers`ï¼Œä¸ä¼šæœ‰é‡å¤è®¡æ•°é—®é¢˜ã€‚

## æ€»ç»“

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„é‡å¤è®¡æ•°é—®é¢˜ï¼ŒåŸå› æ˜¯åœ¨è°ƒç”¨å°è£…å¥½çš„æ–¹æ³•ï¼ˆ`sendAddUserCommand`ï¼‰ä¹‹å‰ï¼Œæ‰‹åŠ¨è°ƒç”¨äº†è¯¥æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨çš„è®¡æ•°æ–¹æ³•ï¼ˆ`incrementSent`ï¼‰ã€‚

ä¿®å¤æ–¹æ³•å¾ˆç®€å•ï¼šåˆ é™¤æ‰‹åŠ¨è°ƒç”¨ï¼Œè®©å°è£…æ–¹æ³•è‡ªå·±å¤„ç†è®¡æ•°ã€‚
