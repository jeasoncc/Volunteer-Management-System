# æ¸…ç©ºè®¾å¤‡åŠŸèƒ½å®Œå–„

## ğŸ”´ é—®é¢˜

1. **æ¸…ç©ºè®¾å¤‡åæ ‡å¿—æ²¡æœ‰æ¶ˆå¤±** - å‰ç«¯ç¼“å­˜æœªåˆ·æ–°
2. **ç¼ºå°‘è¿›åº¦æç¤º** - ç”¨æˆ·ä¸çŸ¥é“æ“ä½œè¿›åº¦
3. **ç¼ºå°‘å®Œæˆæç¤º** - ç”¨æˆ·ä¸çŸ¥é“æ“ä½œæ˜¯å¦æˆåŠŸ

## âœ… å·²ä¿®å¤

### 1. æ¸…ç©ºè®¾å¤‡ååˆ·æ–°å‰ç«¯ç¼“å­˜

**é—®é¢˜**ï¼šç‚¹å‡»"æ¸…ç©ºè®¾å¤‡ç”¨æˆ·"åï¼Œä¹‰å·¥ç®¡ç†é¡µé¢çš„"å·²åŒæ­¥"æ ‡å¿—æ²¡æœ‰æ¶ˆå¤±

**åŸå› **ï¼š
- åç«¯å·²ç»æ¸…é™¤æ•°æ®åº“ä¸­çš„ `syncToAttendance` æ ‡å¿—
- ä½†å‰ç«¯ React Query ç¼“å­˜äº†æ—§æ•°æ®
- æ²¡æœ‰è§¦å‘åˆ·æ–°

**ä¿®å¤**ï¼š
```typescript
const clearMutation = useMutation({
  mutationFn: () => deviceService.clearAllUsers(),
  onSuccess: (res: any) => {
    // âœ… åˆ·æ–°ä¹‰å·¥åˆ—è¡¨ï¼Œæ¸…é™¤åŒæ­¥æ ‡å¿—
    queryClient.invalidateQueries({ queryKey: ["volunteers"] });
    toast.success("æ¸…ç©ºè®¾å¤‡ç”¨æˆ·æˆåŠŸï¼Œå·²æ¸…é™¤æ‰€æœ‰åŒæ­¥æ ‡å¿—");
    setShowClearDialog(false);
    refetchStatus();
  },
});
```

### 2. æ·»åŠ åŒæ­¥å®Œæˆ Toast æç¤º

**é—®é¢˜**ï¼šåŒæ­¥å®Œæˆåæ²¡æœ‰æ˜ç¡®çš„æç¤º

**ä¿®å¤**ï¼š
```typescript
// ç›‘å¬è¿›åº¦å®Œæˆ
useEffect(() => {
  if (data.status === 'completed') {
    // âœ… æ˜¾ç¤ºå®Œæˆæç¤º
    const successCount = data.confirmed;
    const failedCount = data.failed;
    const skippedCount = data.skipped;
    
    if (failedCount === 0 && skippedCount === 0) {
      toast.success(`ğŸ‰ åŒæ­¥å®Œæˆï¼æˆåŠŸ ${successCount} ä¸ª`);
    } else if (failedCount > 0) {
      toast.warning(`åŒæ­¥å®Œæˆï¼šæˆåŠŸ ${successCount}ï¼Œå¤±è´¥ ${failedCount}ï¼Œè·³è¿‡ ${skippedCount}`);
    } else {
      toast.success(`åŒæ­¥å®Œæˆï¼šæˆåŠŸ ${successCount}ï¼Œè·³è¿‡ ${skippedCount}`);
    }
  }
}, [progressData]);
```

### 3. å•ä¸ªåŒæ­¥ä¹Ÿåˆ·æ–°ç¼“å­˜

**é—®é¢˜**ï¼šå•ä¸ªä¸‹å‘åæ ‡å¿—å¯èƒ½ä¸åŠæ—¶æ›´æ–°

**ä¿®å¤**ï¼š
```typescript
const syncOneMutation = useMutation({
  mutationFn: (id: string) => deviceService.syncUser(id),
  onSuccess: (res: any) => {
    // âœ… åˆ·æ–°ä¹‰å·¥åˆ—è¡¨
    queryClient.invalidateQueries({ queryKey: ["volunteers"] });
    toast.success("å·²å‘é€åŒæ­¥å‘½ä»¤ï¼Œç­‰å¾…è€ƒå‹¤æœºç¡®è®¤");
  },
});
```

## ğŸ“Š Toast æç¤ºç­–ç•¥

### åŒæ­¥æ“ä½œ

| åœºæ™¯ | Toast ç±»å‹ | æ¶ˆæ¯ |
|------|-----------|------|
| å¼€å§‹åŒæ­¥ | æ—  | æ˜¾ç¤ºè¿›åº¦æ¡å³å¯ |
| å…¨éƒ¨æˆåŠŸ | Success | ğŸ‰ åŒæ­¥å®Œæˆï¼æˆåŠŸ X ä¸ª |
| æœ‰å¤±è´¥ | Warning | åŒæ­¥å®Œæˆï¼šæˆåŠŸ Xï¼Œå¤±è´¥ Yï¼Œè·³è¿‡ Z |
| æœ‰è·³è¿‡ | Success | åŒæ­¥å®Œæˆï¼šæˆåŠŸ Xï¼Œè·³è¿‡ Y |
| åŒæ­¥å¤±è´¥ | Error | æ‰¹é‡åŒæ­¥å¤±è´¥ |

### å•ä¸ªä¸‹å‘

| åœºæ™¯ | Toast ç±»å‹ | æ¶ˆæ¯ |
|------|-----------|------|
| å‘é€æˆåŠŸ | Success | å·²å‘é€åŒæ­¥å‘½ä»¤ï¼Œç­‰å¾…è€ƒå‹¤æœºç¡®è®¤ |
| å‘é€å¤±è´¥ | Error | å•ä¸ªåŒæ­¥å¤±è´¥ |

### æ¸…ç©ºè®¾å¤‡

| åœºæ™¯ | Toast ç±»å‹ | æ¶ˆæ¯ |
|------|-----------|------|
| æ¸…ç©ºæˆåŠŸ | Success | æ¸…ç©ºè®¾å¤‡ç”¨æˆ·æˆåŠŸï¼Œå·²æ¸…é™¤æ‰€æœ‰åŒæ­¥æ ‡å¿— |
| æ¸…ç©ºå¤±è´¥ | Error | æ¸…ç©ºè®¾å¤‡ç”¨æˆ·å¤±è´¥ |

### é‡è¯•å¤±è´¥é¡¹

| åœºæ™¯ | Toast ç±»å‹ | æ¶ˆæ¯ |
|------|-----------|------|
| é‡è¯•å®Œæˆ | Success | é‡è¯•å®Œæˆ |
| é‡è¯•å¤±è´¥ | Error | é‡è¯•å¤±è´¥ |

## ğŸ”„ å®Œæ•´æµç¨‹

### æ¸…ç©ºè®¾å¤‡æµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»"æ¸…ç©ºè®¾å¤‡ç”¨æˆ·"
   â†“
2. æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
   â†“
3. ç”¨æˆ·ç¡®è®¤
   â†“
4. å‘é€æ¸…ç©ºå‘½ä»¤åˆ°è€ƒå‹¤æœº
   â†“
5. åç«¯æ¸…é™¤æ•°æ®åº“ä¸­æ‰€æœ‰ syncToAttendance æ ‡å¿—
   â†“
6. å‰ç«¯åˆ·æ–°ä¹‰å·¥åˆ—è¡¨ç¼“å­˜
   â†“
7. æ˜¾ç¤º Toast: "æ¸…ç©ºè®¾å¤‡ç”¨æˆ·æˆåŠŸï¼Œå·²æ¸…é™¤æ‰€æœ‰åŒæ­¥æ ‡å¿—"
   â†“
8. ä¹‰å·¥ç®¡ç†é¡µé¢çš„"å·²åŒæ­¥"æ ‡å¿—æ¶ˆå¤± âœ…
```

### æ‰¹é‡åŒæ­¥æµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»"å¼€å§‹åŒæ­¥"
   â†“
2. æ˜¾ç¤ºè¿›åº¦æ¡ï¼ˆ0/0ï¼‰
   â†“
3. å‘é€å‘½ä»¤åˆ°è€ƒå‹¤æœº
   â†“
4. å®æ—¶æ›´æ–°è¿›åº¦ï¼ˆX/Yï¼‰
   â†“
5. è€ƒå‹¤æœºé€ä¸ªè¿”å›ç¡®è®¤
   â†“
6. æ›´æ–°æ•°æ®åº“ syncToAttendance = true
   â†“
7. æ‰€æœ‰å‘½ä»¤å¤„ç†å®Œæˆ
   â†“
8. åˆ·æ–°ä¹‰å·¥åˆ—è¡¨ç¼“å­˜
   â†“
9. æ˜¾ç¤º Toast: "ğŸ‰ åŒæ­¥å®Œæˆï¼æˆåŠŸ X ä¸ª"
   â†“
10. ä¹‰å·¥ç®¡ç†é¡µé¢æ˜¾ç¤º"å·²åŒæ­¥"æ ‡å¿— âœ…
```

### å•ä¸ªä¸‹å‘æµç¨‹

```
1. ç”¨æˆ·è¾“å…¥ lotusId
   â†“
2. ç‚¹å‡»"åŒæ­¥è¯¥ä¹‰å·¥"
   â†“
3. å‘é€å‘½ä»¤åˆ°è€ƒå‹¤æœº
   â†“
4. æ˜¾ç¤º Toast: "å·²å‘é€åŒæ­¥å‘½ä»¤ï¼Œç­‰å¾…è€ƒå‹¤æœºç¡®è®¤"
   â†“
5. åˆ·æ–°ä¹‰å·¥åˆ—è¡¨ç¼“å­˜ï¼ˆç«‹å³ï¼‰
   â†“
6. è€ƒå‹¤æœºè¿”å›ç¡®è®¤
   â†“
7. æ›´æ–°æ•°æ®åº“ syncToAttendance = true
   â†“
8. ä¹‰å·¥ç®¡ç†é¡µé¢æ˜¾ç¤º"å·²åŒæ­¥"æ ‡å¿— âœ…
```

## ğŸ¯ ç”¨æˆ·ä½“éªŒæ”¹è¿›

### ä¹‹å‰

- âŒ æ¸…ç©ºè®¾å¤‡åæ ‡å¿—ä¸æ¶ˆå¤±ï¼Œç”¨æˆ·å›°æƒ‘
- âŒ åŒæ­¥å®Œæˆæ²¡æœ‰æç¤ºï¼Œç”¨æˆ·ä¸ç¡®å®š
- âŒ éœ€è¦æ‰‹åŠ¨åˆ·æ–°é¡µé¢æ‰èƒ½çœ‹åˆ°å˜åŒ–

### ç°åœ¨

- âœ… æ¸…ç©ºè®¾å¤‡åæ ‡å¿—ç«‹å³æ¶ˆå¤±
- âœ… åŒæ­¥å®Œæˆæœ‰æ˜ç¡®çš„ Toast æç¤º
- âœ… è‡ªåŠ¨åˆ·æ–°ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
- âœ… æç¤ºä¿¡æ¯åŒ…å«è¯¦ç»†ç»Ÿè®¡

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯• 1ï¼šæ¸…ç©ºè®¾å¤‡

```
1. åŒæ­¥å‡ ä¸ªä¹‰å·¥ï¼ˆç¡®ä¿æœ‰"å·²åŒæ­¥"æ ‡å¿—ï¼‰
2. æ‰“å¼€ä¹‰å·¥ç®¡ç†é¡µé¢ï¼Œç¡®è®¤æ ‡å¿—å­˜åœ¨
3. è¿”å›è®¾å¤‡é¡µé¢ï¼Œç‚¹å‡»"æ¸…ç©ºè®¾å¤‡ç”¨æˆ·"
4. ç¡®è®¤æ¸…ç©º
5. âœ… åº”è¯¥çœ‹åˆ° Toast: "æ¸…ç©ºè®¾å¤‡ç”¨æˆ·æˆåŠŸï¼Œå·²æ¸…é™¤æ‰€æœ‰åŒæ­¥æ ‡å¿—"
6. è¿”å›ä¹‰å·¥ç®¡ç†é¡µé¢
7. âœ… æ‰€æœ‰"å·²åŒæ­¥"æ ‡å¿—åº”è¯¥æ¶ˆå¤±
```

### æµ‹è¯• 2ï¼šæ‰¹é‡åŒæ­¥

```
1. ç‚¹å‡»"å¼€å§‹åŒæ­¥"
2. âœ… åº”è¯¥çœ‹åˆ°è¿›åº¦æ¡
3. ç­‰å¾…åŒæ­¥å®Œæˆ
4. âœ… åº”è¯¥çœ‹åˆ° Toast: "ğŸ‰ åŒæ­¥å®Œæˆï¼æˆåŠŸ X ä¸ª"
5. æ‰“å¼€ä¹‰å·¥ç®¡ç†é¡µé¢
6. âœ… åº”è¯¥çœ‹åˆ°"å·²åŒæ­¥"æ ‡å¿—
```

### æµ‹è¯• 3ï¼šå•ä¸ªä¸‹å‘

```
1. è¾“å…¥ä¸€ä¸ª lotusId
2. ç‚¹å‡»"åŒæ­¥è¯¥ä¹‰å·¥"
3. âœ… åº”è¯¥çœ‹åˆ° Toast: "å·²å‘é€åŒæ­¥å‘½ä»¤ï¼Œç­‰å¾…è€ƒå‹¤æœºç¡®è®¤"
4. ç­‰å¾…å‡ ç§’
5. æ‰“å¼€ä¹‰å·¥ç®¡ç†é¡µé¢
6. âœ… åº”è¯¥çœ‹åˆ°è¯¥ä¹‰å·¥çš„"å·²åŒæ­¥"æ ‡å¿—
```

### æµ‹è¯• 4ï¼šæœ‰å¤±è´¥çš„åŒæ­¥

```
1. åŒæ­¥ä¸€äº›ä¹‰å·¥ï¼ˆåŒ…æ‹¬æ— å¤´åƒçš„ï¼‰
2. ç­‰å¾…åŒæ­¥å®Œæˆ
3. âœ… åº”è¯¥çœ‹åˆ° Toast: "åŒæ­¥å®Œæˆï¼šæˆåŠŸ Xï¼Œè·³è¿‡ Y"
4. æ‰“å¼€ä¹‰å·¥ç®¡ç†é¡µé¢
5. âœ… æˆåŠŸçš„ä¹‰å·¥æœ‰"å·²åŒæ­¥"æ ‡å¿—
6. âœ… è·³è¿‡çš„ä¹‰å·¥æ²¡æœ‰æ ‡å¿—
```

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `apps/web/src/routes/devices.tsx` - è®¾å¤‡ç®¡ç†é¡µé¢ï¼ˆå·²ä¿®å¤ï¼‰
- `apps/api/src/modules/ws/service.ts` - WebSocket æœåŠ¡
- `apps/web/src/components/VolunteerDataTable.tsx` - ä¹‰å·¥è¡¨æ ¼

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. æ“ä½œååˆ·æ–°ç¼“å­˜

ä»»ä½•ä¿®æ”¹æ•°æ®çš„æ“ä½œåéƒ½åº”è¯¥åˆ·æ–°ç›¸å…³ç¼“å­˜ï¼š

```typescript
// âœ… å¥½çš„åšæ³•
onSuccess: () => {
  queryClient.invalidateQueries({ queryKey: ["volunteers"] });
  toast.success("æ“ä½œæˆåŠŸ");
}

// âŒ ä¸å¥½çš„åšæ³•
onSuccess: () => {
  toast.success("æ“ä½œæˆåŠŸ");
  // å¿˜è®°åˆ·æ–°ç¼“å­˜
}
```

### 2. æä¾›æ˜ç¡®çš„åé¦ˆ

ç”¨æˆ·æ“ä½œååº”è¯¥æœ‰æ˜ç¡®çš„åé¦ˆï¼š

```typescript
// âœ… å¥½çš„åšæ³•
toast.success(`ğŸ‰ åŒæ­¥å®Œæˆï¼æˆåŠŸ ${successCount} ä¸ª`);

// âŒ ä¸å¥½çš„åšæ³•
toast.success("å®Œæˆ");  // å¤ªç®€å•
```

### 3. åŒºåˆ†ä¸åŒçš„ç»“æœ

æ ¹æ®ç»“æœä½¿ç”¨ä¸åŒçš„ Toast ç±»å‹ï¼š

```typescript
// âœ… å¥½çš„åšæ³•
if (failedCount > 0) {
  toast.warning(`æœ‰ ${failedCount} ä¸ªå¤±è´¥`);
} else {
  toast.success("å…¨éƒ¨æˆåŠŸ");
}

// âŒ ä¸å¥½çš„åšæ³•
toast.success("å®Œæˆ");  // ä¸ç®¡æˆåŠŸå¤±è´¥éƒ½ä¸€æ ·
```

## ä¿®å¤æ—¶é—´

2025-11-27
