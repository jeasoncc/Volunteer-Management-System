# 头像筛选功能

## ✨ 新增功能

在义工管理页面添加了头像筛选功能，可以快速筛选有头像和没有头像的义工。

---

## 🎯 功能说明

### 筛选选项

在高级筛选中新增"头像"筛选器，包含两个选项：
- **有头像**：筛选已上传头像的义工
- **无头像**：筛选未上传头像的义工

### 使用场景

1. **批量提醒**：找出所有没有头像的义工，提醒他们上传
2. **数据完整性检查**：检查哪些义工的档案信息不完整
3. **统计分析**：统计有多少义工已上传头像

---

## 🔧 技术实现

### 1. 添加筛选选项

在 `volunteers.tsx` 的 `filterOptions` 中添加：

```typescript
const filterOptions = [
  // ... 其他筛选器
  {
    id: "hasAvatar",
    label: "头像",
    options: [
      { value: "yes", label: "有头像" },
      { value: "no", label: "无头像" },
    ],
  },
];
```

### 2. 实现筛选逻辑

在 `filteredVolunteers` 和 `filteredPendingVolunteers` 的筛选逻辑中添加特殊处理：

```typescript
// 应用筛选条件
if (activeFilters.length > 0) {
  result = result.filter((volunteer) => {
    return activeFilters.every((filter) => {
      if (filter.values.length === 0) return true;
      
      // 特殊处理：头像筛选
      if (filter.id === 'hasAvatar') {
        const hasAvatar = volunteer.avatar && volunteer.avatar.trim() !== '';
        return filter.values.some(value => {
          if (value === 'yes') return hasAvatar;
          if (value === 'no') return !hasAvatar;
          return false;
        });
      }
      
      // 普通字段筛选
      const value = volunteer[filter.id as keyof Volunteer];
      return filter.values.includes(String(value));
    });
  });
}
```

### 3. 判断逻辑

```typescript
const hasAvatar = volunteer.avatar && volunteer.avatar.trim() !== '';
```

**判断规则**：
- `volunteer.avatar` 存在
- 且不是空字符串（去除空格后）

**示例**：
- `avatar: "/upload/avatar/xxx.jpg"` → 有头像 ✅
- `avatar: ""` → 无头像 ❌
- `avatar: null` → 无头像 ❌
- `avatar: "   "` → 无头像 ❌

---

## 📊 使用示例

### 场景1：查找所有没有头像的义工

1. 点击"筛选"按钮
2. 选择"头像" → "无头像"
3. 点击"应用"

**结果**：显示所有未上传头像的义工

### 场景2：查找已注册且有头像的义工

1. 点击"筛选"按钮
2. 选择"状态" → "已注册"
3. 选择"头像" → "有头像"
4. 点击"应用"

**结果**：显示所有已注册且有头像的义工

### 场景3：组合搜索和筛选

1. 在搜索框输入"张"
2. 点击"筛选"按钮
3. 选择"头像" → "无头像"
4. 点击"应用"

**结果**：显示所有姓张且没有头像的义工

---

## 🎨 用户界面

### 筛选器位置

```
义工管理页面
  ↓
高级筛选区域
  ↓
筛选按钮 → 下拉菜单
  ├─ 状态
  ├─ 角色
  ├─ 性别
  └─ 头像 ← 新增
      ├─ 有头像
      └─ 无头像
```

### 筛选标签

选择筛选后，会在筛选器下方显示标签：

```
[头像: 无头像] [x]
```

点击 [x] 可以移除该筛选条件。

---

## 🔄 数据流程

```
用户选择筛选
  ↓
activeFilters 更新
  ↓
filteredVolunteers 重新计算
  ↓
检查每个义工的 avatar 字段
  ├─ 有值且非空 → 有头像
  └─ 无值或空字符串 → 无头像
  ↓
返回符合条件的义工
  ↓
前端分页
  ↓
显示结果
```

---

## 📝 代码位置

### 修改的文件

- `apps/web/src/routes/volunteers.tsx`

### 修改内容

1. **filterOptions**（约第280行）
   - 添加头像筛选选项

2. **filteredVolunteers**（约第320行）
   - 添加头像筛选逻辑

3. **filteredPendingVolunteers**（约第385行）
   - 添加头像筛选逻辑

---

## 🧪 测试场景

### 1. 基本筛选

**测试步骤**：
1. 选择"头像" → "无头像"
2. 查看结果

**预期结果**：
- 只显示 `avatar` 为空或null的义工
- 筛选标签显示"头像: 无头像"

### 2. 组合筛选

**测试步骤**：
1. 选择"状态" → "已注册"
2. 选择"头像" → "有头像"
3. 查看结果

**预期结果**：
- 只显示已注册且有头像的义工
- 筛选标签显示两个标签

### 3. 搜索 + 筛选

**测试步骤**：
1. 搜索"张"
2. 选择"头像" → "无头像"
3. 查看结果

**预期结果**：
- 只显示姓张且没有头像的义工

### 4. 清除筛选

**测试步骤**：
1. 选择"头像" → "无头像"
2. 点击筛选标签的 [x] 按钮
3. 查看结果

**预期结果**：
- 筛选被移除
- 显示所有义工

### 5. 切换标签页

**测试步骤**：
1. 在"全部义工"选择"头像" → "无头像"
2. 切换到"待审批"标签页
3. 查看结果

**预期结果**：
- 筛选条件保持
- 在待审批中也应用相同的筛选

---

## 💡 使用技巧

### 1. 快速找出需要补充头像的义工

```
筛选：头像 → 无头像
导出：导出为Excel
结果：获得所有需要上传头像的义工名单
```

### 2. 统计头像上传率

```
1. 查看"义工总数"：53人
2. 筛选"无头像"：15人
3. 计算：(53-15)/53 = 71.7% 上传率
```

### 3. 批量提醒

```
1. 筛选"无头像"
2. 选中所有义工
3. 导出联系方式
4. 批量发送提醒
```

---

## 🎯 后续优化建议

### 1. 添加统计卡片

在统计概览中添加：
```
有头像义工: 38 / 53 (71.7%)
```

### 2. 添加批量操作

```
选中多个无头像义工 → 批量发送提醒
```

### 3. 添加头像质量筛选

```
- 高质量头像（> 100KB）
- 低质量头像（< 100KB）
- 默认头像
```

### 4. 添加上传时间筛选

```
- 最近上传（7天内）
- 较早上传（30天前）
```

---

## ✅ 总结

头像筛选功能已完成：

1. ✅ **新增筛选器**：在高级筛选中添加"头像"选项
2. ✅ **两个选项**：有头像、无头像
3. ✅ **智能判断**：正确识别空字符串、null等情况
4. ✅ **组合筛选**：可与其他筛选条件组合使用
5. ✅ **全局生效**：在"全部义工"和"待审批"都可用
6. ✅ **即时响应**：前端筛选，无需请求后端

现在可以快速找出需要上传头像的义工了！
