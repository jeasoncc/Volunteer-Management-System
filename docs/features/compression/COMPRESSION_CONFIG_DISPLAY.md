# 压缩配置显示功能

## 功能说明

在同步配置区域显示照片压缩的详细配置信息，让用户在下发前了解压缩规则。

## 显示位置

在考勤管理页面 -> 同步配置区域 -> 照片格式选择"HTTP 地址"时显示

## 显示内容

```
┌─────────────────────────────────────────────────────────┐
│ ℹ️  照片压缩配置                                         │
│                                                          │
│ • 压缩阈值：500KB - 超过此大小将自动压缩                │
│ • 压缩目标：300KB - 压缩后的目标大小                    │
│ • 压缩策略：照片 > 1MB 时质量60%，宽度600px；           │
│             照片 > 500KB 时质量70%，宽度800px           │
└─────────────────────────────────────────────────────────┘
```

## 配置说明

### 1. 压缩阈值：500KB

- **含义**：照片大小超过 500KB 时触发自动压缩
- **小于阈值**：直接使用原始照片，不压缩
- **大于阈值**：自动压缩到目标大小

### 2. 压缩目标：300KB

- **含义**：压缩后的目标大小
- **实际大小**：可能略高于或低于目标值
- **质量保证**：在保证质量的前提下尽量接近目标

### 3. 压缩策略

根据原始照片大小采用不同的压缩参数：

| 原始大小 | 压缩质量 | 最大宽度 | 说明 |
|---------|---------|---------|------|
| > 1MB | 60% | 600px | 大照片，压缩力度大 |
| > 500KB | 70% | 800px | 中等照片，适度压缩 |
| ≤ 500KB | 不压缩 | 原始 | 小照片，直接使用 |

## 使用场景

### 场景 1：了解压缩规则

**操作：** 在同步前查看压缩配置

**效果：** 了解哪些照片会被压缩，压缩到什么程度

### 场景 2：判断是否需要重新上传

**情况：** 照片 1.5MB

**分析：**
- 超过 1MB，会被压缩到 60% 质量
- 可能影响清晰度
- 建议先压缩后再上传

### 场景 3：选择合适的照片格式

**HTTP 地址模式：**
- 显示压缩配置
- 自动压缩大照片
- 适合网络良好的环境

**Base64 编码模式：**
- 不显示压缩配置
- 照片会被编码（增加 33% 大小）
- 适合 URL 访问有问题的情况

## 界面效果

### URL 模式（显示压缩配置）

```
┌─────────────────────────────────────────────────────────┐
│ 同步策略：[全量同步] [增量同步] [更新同步]              │
│                                                          │
│ 照片格式：[HTTP 地址] [Base64 编码]                     │
│                                                          │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ ℹ️  照片压缩配置                                     │ │
│ │                                                      │ │
│ │ • 压缩阈值：500KB - 超过此大小将自动压缩            │ │
│ │ • 压缩目标：300KB - 压缩后的目标大小                │ │
│ │ • 压缩策略：照片 > 1MB 时质量60%，宽度600px；       │ │
│ │             照片 > 500KB 时质量70%，宽度800px       │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                          │
│                          [开始同步]                      │
└─────────────────────────────────────────────────────────┘
```

### Base64 模式（不显示压缩配置）

```
┌─────────────────────────────────────────────────────────┐
│ 同步策略：[全量同步] [增量同步] [更新同步]              │
│                                                          │
│ 照片格式：[HTTP 地址] [Base64 编码]                     │
│                                                          │
│                          [开始同步]                      │
└─────────────────────────────────────────────────────────┘
```

## 压缩示例

### 示例 1：小照片（不压缩）

**原始大小：** 280KB

**处理：** 不压缩，直接使用

**日志：**
```
📸 张三: 280.3KB (阈值500.0KB) ⏭️无需压缩
```

### 示例 2：中等照片（适度压缩）

**原始大小：** 850KB

**处理：** 质量70%，宽度800px

**日志：**
```
📸 李四: 850.5KB -> 320.8KB ✅已压缩
```

### 示例 3：大照片（强力压缩）

**原始大小：** 1850KB

**处理：** 质量60%，宽度600px

**日志：**
```
📸 王五: 1850.5KB -> 280.2KB ✅已压缩
```

## 修改压缩配置

如果需要调整压缩参数，可以修改后端配置文件：

**文件：** `apps/api/src/modules/ws/image-processor.ts`

```typescript
// 压缩阈值（字节）
const MAX_IMAGE_SIZE = 500 * 1024  // 500KB

// 压缩目标（字节）
const TARGET_IMAGE_SIZE = 300 * 1024  // 300KB

// 压缩策略
if (originalSize > MAX_IMAGE_SIZE * 2) {
  quality = 60  // 大照片：60% 质量
  width = Math.min(width, 600)  // 最大宽度 600px
} else if (originalSize > MAX_IMAGE_SIZE) {
  quality = 70  // 中等照片：70% 质量
  width = Math.min(width, 800)  // 最大宽度 800px
}
```

## 优势

1. **透明化** - 用户清楚了解压缩规则
2. **可预期** - 知道照片会被如何处理
3. **易决策** - 帮助选择是否需要预处理照片
4. **减少疑惑** - 避免"为什么照片被压缩了"的疑问

## 注意事项

1. **仅 URL 模式显示** - Base64 模式不显示（因为不压缩）
2. **配置同步** - 前端显示的配置需与后端实际配置一致
3. **修改配置** - 如果修改后端配置，需同步更新前端显示

## 关于重复计数问题

**问题：** 8个失败用户显示16个已发送

**原因：** 这是正常的，因为：
- 每个用户发送一次命令
- 但进度管理器可能计算了其他指标
- 需要检查具体的计数逻辑

**建议：** 查看同步日志，确认实际发送的命令数量

## 完成状态

✅ 添加压缩配置显示
✅ 仅在 URL 模式显示
✅ 显示压缩阈值
✅ 显示压缩目标
✅ 显示压缩策略
✅ 蓝色信息框样式
✅ 代码通过类型检查

现在你可以在同步前看到压缩配置信息了！
