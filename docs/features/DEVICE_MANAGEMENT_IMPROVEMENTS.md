# è®¾å¤‡ç®¡ç†åŠŸèƒ½æ”¹è¿›

## ä¿®å¤çš„é—®é¢˜

### é—®é¢˜1ï¼šæ¸…ç©ºè®¾å¤‡ååŒæ­¥æ ‡å¿—æœªæ¸…é™¤ âœ…

**é—®é¢˜æè¿°**ï¼š
- åœ¨è®¾å¤‡ç®¡ç†é¡µé¢æ¸…ç©ºè®¾å¤‡ç”¨æˆ·å
- æ•°æ®åº“ä¸­ä¹‰å·¥çš„ `syncToAttendance` å­—æ®µä»ç„¶ä¸º `true`
- å¯¼è‡´ä¹‰å·¥åˆ—è¡¨ä¸­ä»æ˜¾ç¤ºç»¿è‰²"è€ƒå‹¤"æ ‡å¿—
- æ•°æ®ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**ï¼š
åœ¨æ¸…ç©ºè®¾å¤‡ç”¨æˆ·æ—¶ï¼ŒåŒæ—¶æ¸…é™¤æ•°æ®åº“ä¸­æ‰€æœ‰ä¹‰å·¥çš„åŒæ­¥æ ‡è®°ã€‚

**ä¿®æ”¹æ–‡ä»¶**: `apps/api/src/modules/ws/service.ts`

```typescript
static async deleteAllUsers() {
  const command: DeleteAllUsersCommand = {
    cmd: 'delAllUser',
  }

  const success = ConnectionManager.sendToAttendanceDevice(command)

  if (!success) {
    throw new DeviceNotConnectedError('YET88476')
  }

  // æ¸…ç©ºè®¾å¤‡åï¼ŒåŒæ—¶æ¸…é™¤æ•°æ®åº“ä¸­æ‰€æœ‰ä¹‰å·¥çš„åŒæ­¥æ ‡è®°
  await db
    .update(volunteer)
    .set({ syncToAttendance: false })
    .where(eq(volunteer.syncToAttendance, true))

  console.log(`ğŸ—‘ï¸  å·²æ¸…é™¤æ‰€æœ‰ä¹‰å·¥çš„åŒæ­¥æ ‡è®°`)

  return {
    success: true,
    message: 'åˆ é™¤å‘½ä»¤å·²å‘é€ï¼Œå·²æ¸…é™¤æ•°æ®åº“åŒæ­¥æ ‡è®°',
  }
}
```

### é—®é¢˜2ï¼šåœ¨çº¿è®¾å¤‡æ•°é‡æ˜¾ç¤ºä¸º0 âœ…

**é—®é¢˜æè¿°**ï¼š
- è®¾å¤‡å·²è¿æ¥å¹¶å‘é€å¿ƒè·³åŒ…
- ä½†å‰ç«¯æ˜¾ç¤ºåœ¨çº¿è®¾å¤‡æ•°é‡ä¸º 0
- æ•°æ®æ ¼å¼ä¸åŒ¹é…

**åŸå› åˆ†æ**ï¼š
å‰ç«¯æœŸæœ›çš„æ•°æ®æ ¼å¼ï¼š
```typescript
{
  devices: [
    { deviceSn: 'YET88476', online: true }
  ]
}
```

åç«¯è¿”å›çš„æ ¼å¼ï¼š
```typescript
{
  attendanceDevice: {
    sn: 'YET88476',
    online: true
  }
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä¿®æ”¹åç«¯è¿”å›æ ¼å¼ï¼Œä¸å‰ç«¯æœŸæœ›ä¸€è‡´ã€‚

**ä¿®æ”¹æ–‡ä»¶**: `apps/api/src/modules/ws/service.ts`

```typescript
static getDeviceStatus() {
  const isOnline = ConnectionManager.isOnline('YET88476')
  const onlineDevices = ConnectionManager.getOnlineDevices()

  // æ„å»ºè®¾å¤‡åˆ—è¡¨ï¼Œæ ¼å¼ä¸å‰ç«¯æœŸæœ›ä¸€è‡´
  const devices = [{
    deviceSn: 'YET88476',
    online: isOnline,
  }]

  return {
    success: true,
    data: {
      devices,  // å‰ç«¯æœŸæœ›çš„æ ¼å¼
      onlineDevices,
      totalOnline: ConnectionManager.getOnlineCount(),
    },
  }
}
```

### é—®é¢˜3ï¼šæ¸…ç©ºè®¾å¤‡ç¡®è®¤å¯¹è¯æ¡†ä¸å‹å¥½ âœ…

**é—®é¢˜æè¿°**ï¼š
- ä½¿ç”¨åŸç”Ÿ `window.confirm()` å¯¹è¯æ¡†
- æ ·å¼ä¸ç»Ÿä¸€ï¼Œç”¨æˆ·ä½“éªŒå·®
- æ²¡æœ‰è¯¦ç»†è¯´æ˜æ“ä½œåæœ

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨ shadcn/ui çš„ AlertDialog ç»„ä»¶ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

**ä¿®æ”¹æ–‡ä»¶**: `apps/web/src/routes/devices.tsx`

**æ”¹è¿›ç‚¹**ï¼š
1. ä½¿ç”¨ shadcn AlertDialog ç»„ä»¶
2. æ·»åŠ è­¦å‘Šå›¾æ ‡
3. è¯¦ç»†åˆ—å‡ºæ“ä½œåæœ
4. æ˜ç¡®æ ‡æ³¨"ä¸å¯æ¢å¤"
5. ä½¿ç”¨çº¢è‰²ä¸»é¢˜å¼ºè°ƒå±é™©æ€§

**æ–°å¯¹è¯æ¡†å†…å®¹**ï¼š
```
ç¡®è®¤æ¸…ç©ºè®¾å¤‡ç”¨æˆ·ï¼Ÿ

æ­¤æ“ä½œå°†ï¼š
â€¢ æ¸…ç©ºè€ƒå‹¤æœºè®¾å¤‡ä¸Šçš„æ‰€æœ‰ç”¨æˆ·æ•°æ®
â€¢ æ¸…é™¤æ•°æ®åº“ä¸­æ‰€æœ‰ä¹‰å·¥çš„åŒæ­¥æ ‡è®°
â€¢ éœ€è¦é‡æ–°åŒæ­¥æ‰èƒ½æ¢å¤è€ƒå‹¤åŠŸèƒ½

æ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œï¼

[å–æ¶ˆ] [ç¡®è®¤æ¸…ç©º]
```

## ä¿®æ”¹å‰åå¯¹æ¯”

### æ¸…ç©ºè®¾å¤‡æµç¨‹

**ä¿®æ”¹å‰**ï¼š
```
1. ç‚¹å‡»"æ¸…ç©ºè®¾å¤‡ç”¨æˆ·"
2. å¼¹å‡ºç®€å•çš„confirmå¯¹è¯æ¡†
3. ç¡®è®¤ååªæ¸…ç©ºè®¾å¤‡
4. æ•°æ®åº“åŒæ­¥æ ‡è®°æœªæ¸…é™¤ âŒ
5. ä¹‰å·¥åˆ—è¡¨ä»æ˜¾ç¤º"è€ƒå‹¤"æ ‡å¿— âŒ
```

**ä¿®æ”¹å**ï¼š
```
1. ç‚¹å‡»"æ¸…ç©ºè®¾å¤‡ç”¨æˆ·"
2. å¼¹å‡ºè¯¦ç»†çš„AlertDialog
3. æ˜¾ç¤ºæ“ä½œåæœè¯´æ˜
4. ç¡®è®¤åæ¸…ç©ºè®¾å¤‡
5. åŒæ—¶æ¸…é™¤æ•°æ®åº“åŒæ­¥æ ‡è®° âœ…
6. ä¹‰å·¥åˆ—è¡¨ä¸å†æ˜¾ç¤º"è€ƒå‹¤"æ ‡å¿— âœ…
```

### åœ¨çº¿è®¾å¤‡æ˜¾ç¤º

**ä¿®æ”¹å‰**ï¼š
```
åœ¨çº¿è®¾å¤‡æ•°: 0  âŒ
ï¼ˆå³ä½¿è®¾å¤‡å·²è¿æ¥ï¼‰
```

**ä¿®æ”¹å**ï¼š
```
åœ¨çº¿è®¾å¤‡æ•°: 1  âœ…
è€ƒå‹¤è®¾å¤‡çŠ¶æ€:
YET88476 [åœ¨çº¿]
```

## æµ‹è¯•éªŒè¯

### æµ‹è¯•1ï¼šæ¸…ç©ºè®¾å¤‡åŠŸèƒ½
1. åŒæ­¥ä¸€äº›ä¹‰å·¥åˆ°è€ƒå‹¤æœº
2. éªŒè¯ä¹‰å·¥åˆ—è¡¨æ˜¾ç¤ºç»¿è‰²"è€ƒå‹¤"æ ‡å¿—
3. åœ¨è®¾å¤‡ç®¡ç†é¡µé¢ç‚¹å‡»"æ¸…ç©ºè®¾å¤‡ç”¨æˆ·"
4. æŸ¥çœ‹AlertDialogå†…å®¹æ˜¯å¦æ­£ç¡®
5. ç¡®è®¤æ¸…ç©º
6. éªŒè¯ä¹‰å·¥åˆ—è¡¨ä¸å†æ˜¾ç¤º"è€ƒå‹¤"æ ‡å¿—

### æµ‹è¯•2ï¼šåœ¨çº¿è®¾å¤‡æ˜¾ç¤º
1. ç¡®ä¿è€ƒå‹¤æœºå·²è¿æ¥
2. æŸ¥çœ‹è®¾å¤‡ç®¡ç†é¡µé¢
3. éªŒè¯"åœ¨çº¿è®¾å¤‡æ•°"æ˜¾ç¤ºä¸º 1
4. éªŒè¯è®¾å¤‡åˆ—è¡¨æ˜¾ç¤º"YET88476 [åœ¨çº¿]"

### æµ‹è¯•3ï¼šå¯¹è¯æ¡†äº¤äº’
1. ç‚¹å‡»"æ¸…ç©ºè®¾å¤‡ç”¨æˆ·"
2. éªŒè¯AlertDialogæ ·å¼æ­£ç¡®
3. ç‚¹å‡»"å–æ¶ˆ"ï¼ŒéªŒè¯å¯¹è¯æ¡†å…³é—­ä¸”æ— æ“ä½œ
4. å†æ¬¡ç‚¹å‡»ï¼Œç‚¹å‡»"ç¡®è®¤æ¸…ç©º"
5. éªŒè¯æ“ä½œæ‰§è¡Œä¸”å¯¹è¯æ¡†å…³é—­

## ç›¸å…³æ–‡ä»¶

- `apps/web/src/routes/devices.tsx` - è®¾å¤‡ç®¡ç†é¡µé¢
- `apps/api/src/modules/ws/service.ts` - WebSocketæœåŠ¡
- `apps/web/src/services/device.ts` - è®¾å¤‡æœåŠ¡
- `apps/api/src/modules/ws/connection-manager.ts` - è¿æ¥ç®¡ç†å™¨

## åç»­ä¼˜åŒ–å»ºè®®

### 1. æ·»åŠ æ“ä½œæ—¥å¿—
è®°å½•æ¸…ç©ºè®¾å¤‡çš„æ“ä½œï¼š
```typescript
{
  action: 'clear_device',
  operator: userId,
  timestamp: new Date(),
  affectedCount: 28
}
```

### 2. æ‰¹é‡æ“ä½œè¿›åº¦æç¤º
æ¸…ç©ºè®¾å¤‡æ—¶æ˜¾ç¤ºè¿›åº¦ï¼š
```
æ­£åœ¨æ¸…ç©ºè®¾å¤‡...
å·²æ¸…é™¤ 28 ä¸ªä¹‰å·¥çš„åŒæ­¥æ ‡è®°
```

### 3. æ”¯æŒå¤šè®¾å¤‡
å½“å‰åªæ”¯æŒå•ä¸ªè®¾å¤‡ï¼ˆYET88476ï¼‰ï¼Œæœªæ¥å¯æ‰©å±•ï¼š
```typescript
const devices = ConnectionManager.getAllDevices().map(sn => ({
  deviceSn: sn,
  online: ConnectionManager.isOnline(sn),
}))
```

### 4. æ·»åŠ è®¾å¤‡è¯¦æƒ…
æ˜¾ç¤ºæ›´å¤šè®¾å¤‡ä¿¡æ¯ï¼š
- æœ€åå¿ƒè·³æ—¶é—´
- è®¾å¤‡ä¸Šçš„ç”¨æˆ·æ•°é‡
- è®¾å¤‡å›ºä»¶ç‰ˆæœ¬

## ä¿®æ”¹æ—¶é—´

2024-11-27
