# 满勤功能使用指南

## 功能说明

为驻堂义工或长期服务的义工设置满勤标记，导出考勤报表时自动填充每天12小时的考勤数据。

## 使用步骤

### 1. 设置义工为满勤

**方法1：编辑现有义工**
1. 进入义工管理页面
2. 点击义工操作菜单（三个点）→ "编辑信息"
3. 在"义工信息"卡片中找到"满勤配置"
4. 勾选"导出考勤时自动填充满勤（每天12小时）"
5. 点击"保存更新"

**方法2：添加新义工时设置**
1. 点击"添加义工"
2. 填写基本信息
3. 在"义工信息"卡片中勾选"满勤配置"
4. 点击"创建义工"

### 2. 查看满勤标记

在义工管理列表中，"满勤"列会显示：
- 🟡 **满勤** 徽章 - 已设置为满勤
- **-** - 未设置

### 3. 导出考勤报表（含满勤数据）

1. 进入考勤管理页面
2. 选择要导出的月份
3. 点击"导出"按钮
4. 系统会自动：
   - 获取该月所有考勤记录
   - 检查义工的满勤标记
   - 为标记为满勤的义工填充缺失日期的考勤数据（每天12小时）
   - 合并实际考勤和满勤数据
   - 导出到Excel

## 导出示例

### 义工A（未设置满勤）
```
姓名: 张三
2024-12-01: 8小时 (实际打卡)
2024-12-02: 无记录
2024-12-03: 6小时 (实际打卡)
...
总工时: 14小时
```

### 义工B（已设置满勤）
```
姓名: 李四 [满勤]
2024-12-01: 8小时 (实际打卡)
2024-12-02: 12小时 (满勤补充)
2024-12-03: 6小时 (实际打卡)
2024-12-04: 12小时 (满勤补充)
...
总工时: 360小时
```

## 满勤规则

1. **优先使用实际考勤**
   - 如果某天有实际打卡记录，使用实际记录
   - 只在没有记录的日期填充满勤数据

2. **固定工时**
   - 每天12小时
   - 签到时间：08:00（随机±30分钟）
   - 签退时间：20:00（随机±30分钟）

3. **标识说明**
   - 报表中会标注"[满勤]"或"(满勤补充)"
   - 便于区分实际打卡和满勤数据

## 适用场景

### 1. 驻堂义工
- 长期住在寺院
- 每天固定服务
- 不需要每天打卡

### 2. 全职义工
- 全职服务的义工
- 固定工作时间
- 简化考勤管理

### 3. 特殊情况
- 考勤机故障期间
- 历史数据补录
- 月度考勤统计

## 注意事项

1. **不写入数据库**
   - 满勤数据只在导出时动态生成
   - 不会污染实际考勤记录
   - 可以随时修改满勤标记

2. **实际打卡优先**
   - 如果某天有实际打卡，使用实际数据
   - 满勤只填充缺失的日期

3. **灵活调整**
   - 可以随时开启/关闭满勤标记
   - 不影响已有的考勤记录

4. **报表区分**
   - 导出的报表会明确标注满勤数据
   - 便于审计和核对

## 界面展示

### 义工列表
```
┌────────────────────────────────────────────────┐
│ 姓名    状态    满勤    性别    手机号         │
├────────────────────────────────────────────────┤
│ 张三    已注册   -      男     138xxxx        │
│ 李四    已注册  [满勤]  女     139xxxx        │
│ 王五    培训中   -      男     137xxxx        │
└────────────────────────────────────────────────┘
```

### 编辑表单
```
┌─ 义工信息 ─────────────────────────────────┐
│                                             │
│ 服务岗位: [厨房 ▼]    义工状态: [已注册 ▼] │
│                                             │
│ 满勤配置:                                   │
│ ☑ 导出考勤时自动填充满勤（每天12小时）      │
│                                             │
└─────────────────────────────────────────────┘
```

## 常见问题

### Q1: 如何批量设置满勤？

**答：** 目前需要逐个编辑。未来可以添加批量操作功能。

### Q2: 可以修改满勤工时吗？

**答：** 目前固定为12小时。如需调整，可以在导出逻辑中修改。

### Q3: 满勤数据会覆盖实际打卡吗？

**答：** 不会！实际打卡记录优先，满勤只填充缺失的日期。

### Q4: 如何取消满勤？

**答：** 编辑义工信息，取消勾选"满勤配置"即可。

### Q5: 满勤数据保存在哪里？

**答：** 不保存！只在导出时动态生成，保持数据库干净。

## 技术实现

### 数据字段

**表：** `volunteer`
**字段：** `require_full_attendance`
- 类型：BOOLEAN
- 默认值：FALSE
- 说明：是否需要考勤全勤配置

### 前端组件

**文件：** `apps/web/src/components/VolunteerForm.tsx`

**满勤开关：**
```typescript
<form.Field name="requireFullAttendance">
  {(field) => (
    <input
      type="checkbox"
      checked={field.state.value}
      onChange={(e) => field.handleChange(e.target.checked)}
    />
  )}
</form.Field>
```

### 导出逻辑（待实现）

在考勤导出功能中：
```typescript
// 1. 获取义工信息
const volunteer = await getVolunteer(lotusId);

// 2. 获取实际考勤记录
const actualRecords = await getCheckInRecords(lotusId, year, month);

// 3. 如果设置了满勤，填充缺失日期
if (volunteer.requireFullAttendance) {
  const allDates = getAllDatesInMonth(year, month);
  const existingDates = new Set(actualRecords.map(r => r.date));
  
  for (const date of allDates) {
    if (!existingDates.has(date)) {
      // 添加满勤数据
      actualRecords.push({
        date,
        hours: 12,
        type: 'perfect_attendance',
        checkIn: '08:00',
        checkOut: '20:00',
      });
    }
  }
}

// 4. 导出
exportToExcel(actualRecords);
```

## 总结

满勤功能通过简单的复选框配置，在导出时自动填充考勤数据，既保持了数据库的干净，又满足了驻堂义工的考勤统计需求。

**关键特点：**
- ✅ 简单易用（一个复选框）
- ✅ 数据干净（不写入数据库）
- ✅ 灵活调整（随时开启/关闭）
- ✅ 实际优先（不覆盖真实打卡）
