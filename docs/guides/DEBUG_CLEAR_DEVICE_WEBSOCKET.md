# è°ƒè¯•æ¸…ç©ºè®¾å¤‡ WebSocket æ¶ˆæ¯

## é—®é¢˜

æ¸…ç©ºè®¾å¤‡åï¼Œè€ƒå‹¤æœºè¿”å›äº†ç¡®è®¤æ¶ˆæ¯ï¼Œä½†å‰ç«¯æ²¡æœ‰æ”¶åˆ° Toast å’Œé€šçŸ¥ã€‚

## è°ƒè¯•æ­¥éª¤

### 1. æ£€æŸ¥æœåŠ¡ç«¯æ—¥å¿—

æ‰§è¡Œæ¸…ç©ºæ“ä½œåï¼ŒæŸ¥çœ‹æœåŠ¡ç«¯æ§åˆ¶å°ï¼Œåº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š

```bash
# 1. å‘é€æ¸…ç©ºå‘½ä»¤
ğŸ“¤ å·²å‘é€æ¸…ç©ºè®¾å¤‡å‘½ä»¤ï¼Œç­‰å¾…è€ƒå‹¤æœºç¡®è®¤...

# 2. æ”¶åˆ°è€ƒå‹¤æœºè¿”å›
å¤„ç†æ¸…ç©ºè®¾å¤‡ç»“æœ: code=0, msg=åˆ é™¤æˆåŠŸ

# 3. å¼€å§‹å¤„ç†
ğŸ” å¼€å§‹å¤„ç†æ¸…ç©ºè®¾å¤‡ç»“æœ: code=0, msg=åˆ é™¤æˆåŠŸ

# 4. æ•°æ®åº“æ›´æ–°
âœ… è€ƒå‹¤æœºç¡®è®¤æ¸…ç©ºæˆåŠŸï¼Œå·²æ¸…é™¤æ•°æ®åº“åŒæ­¥æ ‡è®°

# 5. å‡†å¤‡å¹¿æ’­
ğŸ“¡ å‡†å¤‡å¹¿æ’­æ¸…ç©ºå®Œæˆæ¶ˆæ¯åˆ°å‰ç«¯

# 6. å¹¿æ’­æ¶ˆæ¯
ğŸ“¡ å¹¿æ’­æ¸…ç©ºè®¾å¤‡å®Œæˆæ¶ˆæ¯: {"success":true,"code":0,"message":"è®¾å¤‡ç”¨æˆ·å·²æ¸…ç©ºï¼Œæ•°æ®åº“åŒæ­¥æ ‡è®°å·²é‡ç½®"}
ğŸ“Š å½“å‰å‰ç«¯å®¢æˆ·ç«¯æ•°é‡: 1

# 7. å¹¿æ’­å®Œæˆ
âœ… å·²å¹¿æ’­æ¸…ç©ºå®Œæˆæ¶ˆæ¯
```

### 2. æ£€æŸ¥å‰ç«¯ WebSocket è¿æ¥

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰â†’ Consoleï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```javascript
// 1. WebSocket è¿æ¥æˆåŠŸ
âœ… åŒæ­¥è¿›åº¦ WebSocket å·²è¿æ¥

// 2. æ”¶åˆ°æ¶ˆæ¯
ğŸ“¨ æ”¶åˆ° WebSocket æ¶ˆæ¯: {
  type: "clear_device_complete",
  data: {
    success: true,
    code: 0,
    message: "è®¾å¤‡ç”¨æˆ·å·²æ¸…ç©ºï¼Œæ•°æ®åº“åŒæ­¥æ ‡è®°å·²é‡ç½®"
  }
}

// 3. å¤„ç†æ¶ˆæ¯
ğŸ”” æ”¶åˆ°æ¸…ç©ºè®¾å¤‡å®Œæˆæ¶ˆæ¯: {success: true, code: 0, message: "..."}
âœ… è°ƒç”¨ onClearDeviceComplete å›è°ƒ
```

### 3. æ£€æŸ¥ WebSocket è¿æ¥çŠ¶æ€

åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­ï¼š

1. **Network æ ‡ç­¾** â†’ **WS** è¿‡æ»¤å™¨
2. æ‰¾åˆ° `sync-progress` è¿æ¥
3. ç‚¹å‡»æŸ¥çœ‹ **Messages** æ ‡ç­¾
4. åº”è¯¥èƒ½çœ‹åˆ° `clear_device_complete` æ¶ˆæ¯

### 4. å¸¸è§é—®é¢˜æ’æŸ¥

#### é—®é¢˜ 1ï¼šæœåŠ¡ç«¯æ²¡æœ‰æ—¥å¿—
**å¯èƒ½åŸå› **ï¼š
- è€ƒå‹¤æœºæ²¡æœ‰è¿”å› `delAllUserRet` æ¶ˆæ¯
- WebSocket æ¶ˆæ¯å¤„ç†å‡ºé”™

**è§£å†³æ–¹æ³•**ï¼š
```bash
# æŸ¥çœ‹å®Œæ•´çš„ WebSocket æ¶ˆæ¯
# åœ¨æœåŠ¡ç«¯æ—¥å¿—ä¸­æœç´¢ "æ”¶åˆ°å…¶ä»–æ¶ˆæ¯"
```

#### é—®é¢˜ 2ï¼šæœåŠ¡ç«¯æœ‰æ—¥å¿—ï¼Œä½†å‰ç«¯æ²¡æ”¶åˆ°
**å¯èƒ½åŸå› **ï¼š
- å‰ç«¯ WebSocket æœªè¿æ¥
- `frontendClients.size` ä¸º 0

**è§£å†³æ–¹æ³•**ï¼š
```bash
# 1. æ£€æŸ¥æœåŠ¡ç«¯æ—¥å¿—ä¸­çš„ "å½“å‰å‰ç«¯å®¢æˆ·ç«¯æ•°é‡"
# 2. å¦‚æœä¸º 0ï¼Œè¯´æ˜å‰ç«¯ WebSocket æœªè¿æ¥
# 3. åˆ·æ–°é¡µé¢é‡æ–°è¿æ¥
```

#### é—®é¢˜ 3ï¼šå‰ç«¯æ”¶åˆ°æ¶ˆæ¯ä½†æ²¡æœ‰ Toast
**å¯èƒ½åŸå› **ï¼š
- `onClearDeviceComplete` å›è°ƒæœªå®šä¹‰
- å›è°ƒå‡½æ•°ä¸­æœ‰é”™è¯¯

**è§£å†³æ–¹æ³•**ï¼š
```javascript
// æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°
// åº”è¯¥çœ‹åˆ° "âœ… è°ƒç”¨ onClearDeviceComplete å›è°ƒ"
// å¦‚æœçœ‹åˆ° "âš ï¸ onClearDeviceComplete å›è°ƒæœªå®šä¹‰"
// è¯´æ˜å›è°ƒæ²¡æœ‰æ­£ç¡®ä¼ é€’
```

### 5. å®Œæ•´çš„è°ƒè¯•æ£€æŸ¥æ¸…å•

- [ ] æœåŠ¡ç«¯æ—¥å¿—æ˜¾ç¤º "ğŸ“¤ å·²å‘é€æ¸…ç©ºè®¾å¤‡å‘½ä»¤"
- [ ] æœåŠ¡ç«¯æ—¥å¿—æ˜¾ç¤º "å¤„ç†æ¸…ç©ºè®¾å¤‡ç»“æœ: code=0"
- [ ] æœåŠ¡ç«¯æ—¥å¿—æ˜¾ç¤º "âœ… è€ƒå‹¤æœºç¡®è®¤æ¸…ç©ºæˆåŠŸ"
- [ ] æœåŠ¡ç«¯æ—¥å¿—æ˜¾ç¤º "ğŸ“¡ å¹¿æ’­æ¸…ç©ºè®¾å¤‡å®Œæˆæ¶ˆæ¯"
- [ ] æœåŠ¡ç«¯æ—¥å¿—æ˜¾ç¤º "å½“å‰å‰ç«¯å®¢æˆ·ç«¯æ•°é‡: 1"ï¼ˆæˆ–æ›´å¤šï¼‰
- [ ] æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤º "ğŸ“¨ æ”¶åˆ° WebSocket æ¶ˆæ¯"
- [ ] æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤º "ğŸ”” æ”¶åˆ°æ¸…ç©ºè®¾å¤‡å®Œæˆæ¶ˆæ¯"
- [ ] æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤º "âœ… è°ƒç”¨ onClearDeviceComplete å›è°ƒ"
- [ ] å‰ç«¯æ˜¾ç¤º Toast "è®¾å¤‡ç”¨æˆ·å·²æ¸…ç©º"
- [ ] é€šçŸ¥ä¸­å¿ƒæ·»åŠ  "è®¾å¤‡å·²æ¸…ç©º" é€šçŸ¥

### 6. æ‰‹åŠ¨æµ‹è¯• WebSocket è¿æ¥

åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­è¿è¡Œï¼š

```javascript
// æ£€æŸ¥ WebSocket è¿æ¥çŠ¶æ€
const ws = new WebSocket('ws://localhost:3000/ws/sync-progress');
ws.onopen = () => console.log('âœ… WebSocket è¿æ¥æˆåŠŸ');
ws.onmessage = (event) => console.log('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯:', JSON.parse(event.data));
ws.onerror = (error) => console.error('âŒ WebSocket é”™è¯¯:', error);
```

### 7. æ£€æŸ¥å›è°ƒå‡½æ•°

åœ¨ `apps/web/src/routes/devices.tsx` ä¸­ï¼Œç¡®è®¤ `useSyncWebSocket` åŒ…å« `onClearDeviceComplete` å›è°ƒï¼š

```typescript
const { isConnected } = useSyncWebSocket({
  enabled: true,
  onProgressUpdate: (progress) => { ... },
  onUserFeedback: (feedback) => { ... },
  onBatchStart: (batch) => { ... },
  onBatchComplete: (result) => { ... },
  onClearDeviceComplete: (result) => {  // â† ç¡®è®¤è¿™ä¸ªå›è°ƒå­˜åœ¨
    if (result.success) {
      toast.success(result.message);
      addNotification({ ... });
      refetchStatus();
    } else {
      toast.error(`æ¸…ç©ºå¤±è´¥ï¼š${result.message}`);
      addNotification({ ... });
    }
  },
});
```

## é¢„æœŸè¡Œä¸º

### æ­£å¸¸æµç¨‹

1. **ç”¨æˆ·ç‚¹å‡»æ¸…ç©º**
   - Toast: "æ­£åœ¨æ¸…ç©ºè®¾å¤‡ç”¨æˆ·ï¼Œç­‰å¾…è€ƒå‹¤æœºç¡®è®¤..."
   - é€šçŸ¥ä¸­å¿ƒ: "å¼€å§‹æ¸…ç©ºè®¾å¤‡"

2. **æœåŠ¡ç«¯å‘é€å‘½ä»¤**
   - æ—¥å¿—: "ğŸ“¤ å·²å‘é€æ¸…ç©ºè®¾å¤‡å‘½ä»¤ï¼Œç­‰å¾…è€ƒå‹¤æœºç¡®è®¤..."

3. **è€ƒå‹¤æœºå¤„ç†**ï¼ˆçº¦ 5 ç§’ï¼‰

4. **è€ƒå‹¤æœºè¿”å›ç¡®è®¤**
   - æ—¥å¿—: "å¤„ç†æ¸…ç©ºè®¾å¤‡ç»“æœ: code=0, msg=åˆ é™¤æˆåŠŸ"

5. **æœåŠ¡ç«¯å¤„ç†å¹¶å¹¿æ’­**
   - æ—¥å¿—: "âœ… è€ƒå‹¤æœºç¡®è®¤æ¸…ç©ºæˆåŠŸï¼Œå·²æ¸…é™¤æ•°æ®åº“åŒæ­¥æ ‡è®°"
   - æ—¥å¿—: "ğŸ“¡ å¹¿æ’­æ¸…ç©ºè®¾å¤‡å®Œæˆæ¶ˆæ¯"

6. **å‰ç«¯æ”¶åˆ°å¹¶æ˜¾ç¤º**
   - æ§åˆ¶å°: "ğŸ“¨ æ”¶åˆ° WebSocket æ¶ˆæ¯"
   - æ§åˆ¶å°: "ğŸ”” æ”¶åˆ°æ¸…ç©ºè®¾å¤‡å®Œæˆæ¶ˆæ¯"
   - Toast: "è®¾å¤‡ç”¨æˆ·å·²æ¸…ç©ºï¼Œæ•°æ®åº“åŒæ­¥æ ‡è®°å·²é‡ç½®"
   - é€šçŸ¥ä¸­å¿ƒ: "è®¾å¤‡å·²æ¸…ç©º"

## ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

å¦‚æœ WebSocket æ¶ˆæ¯æ— æ³•æ­£å¸¸å·¥ä½œï¼Œå¯ä»¥ä¸´æ—¶ä½¿ç”¨è½®è¯¢æ–¹æ¡ˆï¼š

```typescript
// åœ¨ clearMutation.onSuccess ä¸­æ·»åŠ è½®è¯¢
onSuccess: () => {
  queryClient.invalidateQueries({ queryKey: ["volunteers"] });
  setShowClearDialog(false);
  
  // ä¸´æ—¶æ–¹æ¡ˆï¼šè½®è¯¢æ£€æŸ¥æ¸…ç©ºçŠ¶æ€
  const checkInterval = setInterval(async () => {
    try {
      const status = await deviceService.getStatus();
      // æ£€æŸ¥è®¾å¤‡çŠ¶æ€æˆ–å…¶ä»–æŒ‡æ ‡
      // å¦‚æœç¡®è®¤æ¸…ç©ºæˆåŠŸï¼Œæ˜¾ç¤ºæç¤º
      clearInterval(checkInterval);
      toast.success("è®¾å¤‡ç”¨æˆ·å·²æ¸…ç©º");
      addNotification({ ... });
    } catch (error) {
      // ç»§ç»­è½®è¯¢
    }
  }, 1000);
  
  // 10ç§’ååœæ­¢è½®è¯¢
  setTimeout(() => clearInterval(checkInterval), 10000);
},
```

## ç›¸å…³æ–‡ä»¶

- `apps/api/src/modules/ws/index.ts` - WebSocket æ¶ˆæ¯å¤„ç†å’Œå¹¿æ’­
- `apps/api/src/modules/ws/service.ts` - æ¸…ç©ºè®¾å¤‡å¤„ç†é€»è¾‘
- `apps/web/src/hooks/useSyncWebSocket.ts` - WebSocket Hook
- `apps/web/src/routes/devices.tsx` - è®¾å¤‡é¡µé¢

## æ›´æ–°æ—¥å¿—

**2024-11-28**
- âœ… æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
- âœ… æ·»åŠ å‰ç«¯ WebSocket æ¶ˆæ¯æ—¥å¿—
- âœ… æ·»åŠ æœåŠ¡ç«¯å¹¿æ’­æ—¥å¿—
- âœ… åˆ›å»ºè°ƒè¯•æŒ‡å—
