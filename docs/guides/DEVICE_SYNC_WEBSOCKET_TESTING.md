# 设备同步 WebSocket 功能测试指南

## 快速开始

### 1. 启动服务

```bash
# 启动后端服务
cd apps/api
bun run dev

# 启动前端服务
cd apps/web
bun run dev
```

### 2. 访问新页面

打开浏览器访问：`http://localhost:5173/devices-new`

### 3. 检查 WebSocket 连接

页面标题下方应该显示绿色的 "● 已连接" 标签，表示 WebSocket 已成功连接。

## 测试场景

### 场景 1：单个用户同步

**目的**：测试单个用户的实时反馈

**步骤**：
1. 在"单个同步"输入框中输入一个莲花斋ID（如 `LHZ0001`）
2. 点击"同步"按钮
3. 观察 Toast 提示："命令已发送，等待考勤机确认..."

**预期结果**：
- 如果成功：不显示额外 Toast（避免刷屏）
- 如果失败：显示红色 Toast 提示失败原因
- 通知中心会记录失败通知

---

### 场景 2：小批量同步（10个用户）

**目的**：测试基础批量同步和实时进度

**步骤**：
1. 选择同步策略（建议选"增量同步"）
2. 选择照片格式（建议选"HTTP 地址"）
3. 点击"开始同步"按钮
4. 观察进度面板的实时更新

**预期结果**：
- ✅ 立即显示 Toast："正在下发 X 个人员信息，请等待考勤机反馈..."
- ✅ 通知中心添加"开始同步"通知
- ✅ 进度条实时更新（无延迟）
- ✅ 日志实时滚动显示
- ✅ 统计数据实时更新（已发送、成功、失败、跳过）
- ✅ 显示预计剩余时间
- ✅ 完成后显示 Toast 和通知

---

### 场景 3：大批量同步（100+个用户）

**目的**：测试性能和稳定性

**步骤**：
1. 选择"全量同步"
2. 选择"HTTP 地址"
3. 点击"开始同步"
4. 观察整个同步过程

**预期结果**：
- ✅ 进度条流畅更新
- ✅ 日志不卡顿
- ✅ 预计时间准确
- ✅ 内存占用正常
- ✅ 完成后统计准确

---

### 场景 4：失败处理

**目的**：测试失败用户的反馈和重试

**步骤**：
1. 同步一些没有照片的用户（会被跳过）
2. 同步一些照片格式不正确的用户（会失败）
3. 观察失败提示
4. 点击"重试"按钮

**预期结果**：
- ✅ 每个失败用户都显示红色 Toast
- ✅ 通知中心记录所有失败通知
- ✅ 失败面板显示失败数量和原因
- ✅ 重试功能正常工作

---

### 场景 5：WebSocket 断线重连

**目的**：测试网络异常情况

**步骤**：
1. 开始一个批量同步
2. 在同步过程中，停止后端服务（模拟断线）
3. 观察前端反应
4. 重启后端服务
5. 观察是否自动重连

**预期结果**：
- ✅ 断线后显示警告
- ✅ 自动尝试重连（最多5次）
- ✅ 重连成功后继续接收消息
- ✅ 进度数据不丢失

---

### 场景 6：并发同步

**目的**：测试多个同步任务的处理

**步骤**：
1. 开始一个批量同步
2. 在同步过程中，尝试开始另一个同步
3. 观察系统反应

**预期结果**：
- ✅ 显示错误提示："同步正在进行中，请稍后再试"
- ✅ 第一个同步任务不受影响
- ✅ 第一个任务完成后，可以开始新任务

---

### 场景 7：通知中心集成

**目的**：测试通知中心的完整功能

**步骤**：
1. 执行一次完整的批量同步（包含成功和失败）
2. 点击右上角的通知中心图标
3. 查看通知列表

**预期结果**：
- ✅ 显示"开始同步"通知
- ✅ 显示所有失败用户的通知
- ✅ 显示"同步完成"通知
- ✅ 通知类型为"设备同步"（青色图标）
- ✅ 点击通知可以跳转到设备页面

---

## 性能指标

### 实时性
- 进度更新延迟：< 100ms
- 用户反馈延迟：< 100ms
- Toast 显示延迟：< 50ms

### 资源占用
- WebSocket 连接数：1
- 内存占用：< 50MB（100个用户）
- CPU 占用：< 5%（同步过程中）

### 可靠性
- WebSocket 重连成功率：> 95%
- 消息丢失率：0%
- 进度准确率：100%

---

## 调试技巧

### 1. 查看 WebSocket 消息

打开浏览器开发者工具 → Network → WS → 选择 `sync-progress` 连接 → Messages

可以看到所有实时消息：
- `progress`: 进度更新
- `user_feedback`: 用户反馈
- `batch_start`: 批次开始
- `batch_complete`: 批次完成

### 2. 查看服务端日志

后端控制台会显示详细的同步日志：
```
📊 共查询到 10 个义工用于同步考勤机
📸 照片格式: HTTP URL
🌐 照片服务器地址: http://localhost:3000
📤 已发送: 张三(LHZ0001)，等待考勤机确认...
✅ 考勤机确认成功: LHZ0001
❌ 考勤机返回失败: 李四(LHZ0002) - [错误码:11] 没有找到有效人脸
🎉 同步完成！成功 8，失败 2，跳过 0
```

### 3. 查看通知中心数据

打开浏览器开发者工具 → Application → Local Storage → `app-notifications`

可以看到所有通知的 JSON 数据。

---

## 常见问题

### Q1: WebSocket 显示"未连接"
**A**: 检查后端服务是否启动，WebSocket 端点是否正确（`ws://localhost:3000/ws/sync-progress`）

### Q2: 进度不更新
**A**: 检查 WebSocket 连接状态，查看浏览器控制台是否有错误

### Q3: Toast 不显示
**A**: 检查 `sonner` 组件是否正确配置，查看 `apps/web/src/lib/toast.ts`

### Q4: 通知中心没有记录
**A**: 检查 `useNotifications` hook 是否正确调用，查看 LocalStorage 数据

### Q5: 考勤机没有反馈
**A**: 检查考勤机是否在线，查看服务端日志确认命令是否发送成功

---

## 对比测试

### 旧版页面（轮询）
访问：`http://localhost:5173/devices`

**特点**：
- 每秒发送一次 HTTP 请求
- 进度更新有 1-2 秒延迟
- 网络请求多

### 新版页面（WebSocket）
访问：`http://localhost:5173/devices-new`

**特点**：
- 实时双向通信
- 进度更新无延迟
- 网络请求少

**建议**：同时打开两个页面，执行相同的同步任务，对比效果。

---

## 测试清单

- [ ] WebSocket 连接成功
- [ ] 单个用户同步正常
- [ ] 小批量同步（10个）正常
- [ ] 大批量同步（100+个）正常
- [ ] 进度实时更新
- [ ] Toast 提示正确
- [ ] 通知中心记录完整
- [ ] 失败重试功能正常
- [ ] WebSocket 断线重连正常
- [ ] 并发同步处理正确
- [ ] 性能指标达标
- [ ] 无内存泄漏
- [ ] 无控制台错误

---

## 反馈

如果发现任何问题，请记录：
1. 问题描述
2. 复现步骤
3. 浏览器控制台截图
4. 服务端日志截图
5. 预期结果 vs 实际结果
