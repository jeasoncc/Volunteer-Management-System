<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CSV解析测试</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <h1>CSV解析测试</h1>
    <input type="file" id="fileInput" accept=".csv">
    <pre id="output"></pre>

    <script>
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: "binary" });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    console.log("原始解析数据:", jsonData);

                    // 辅助函数：清理空值
                    const cleanValue = (value) => {
                        if (value === "" || value === null || value === undefined) {
                            return undefined;
                        }
                        return value;
                    };

                    // 映射数据
                    const mappedData = jsonData.map((row) => {
                        // 处理性别
                        let gender = "other";
                        if (row["性别"] === "男") gender = "male";
                        else if (row["性别"] === "女") gender = "female";
                        else if (row["性别"] === "其他") gender = "other";
                        else if (row["gender"]) gender = row["gender"];
                        
                        // 处理学历
                        const educationMap = {
                            "小学": "elementary",
                            "初中": "middle_school",
                            "高中": "high_school",
                            "中专": "technical_secondary",
                            "专科": "associate",
                            "本科": "bachelor",
                            "硕士": "master",
                            "博士": "doctor",
                        };
                        const educationValue = row["学历"] || row["education"];
                        const education = educationValue ? (educationMap[educationValue] || educationValue) : undefined;
                        
                        // 处理宗教背景
                        const religionMap = {
                            "佛教": "upasaka",
                            "无": "none",
                        };
                        const religionValue = row["宗教背景"] || row["religiousBackground"] || row["宗教信仰"];
                        const religiousBackground = religionValue ? (religionMap[religionValue] || religionValue) : undefined;
                        
                        // 处理皈依状态
                        const refugeMap = {
                            "皈依": "took_refuge",
                            "已皈依": "took_refuge",
                            "无": "none",
                            "未皈依": "none",
                        };
                        const refugeValue = row["皈依状态"] || row["refugeStatus"] || row["是否皈依"];
                        const refugeStatus = refugeValue ? (refugeMap[refugeValue] || refugeValue) : undefined;
                        
                        // 处理健康状况
                        const healthMap = {
                            "很好": "healthy",
                            "无疾病": "healthy",
                            "健康": "healthy",
                            "一般": "has_chronic_disease",
                            "较差": "has_chronic_disease",
                        };
                        const healthValue = row["健康状况"] || row["healthConditions"];
                        const healthConditions = healthValue ? (healthMap[healthValue] || healthValue) : undefined;
                        
                        // 构建数据对象
                        const data = {
                            name: cleanValue(row["姓名"] || row["name"]),
                            phone: cleanValue(row["手机号"] || row["phone"]),
                            idNumber: cleanValue(row["身份证号"] || row["idNumber"]),
                            gender,
                        };

                        // 只添加非空的可选字段
                        const optionalFields = {
                            birthDate: cleanValue(row["出生日期"] || row["birthDate"] || row["出生年月"]),
                            email: cleanValue(row["邮箱"] || row["email"]),
                            address: cleanValue(row["地址"] || row["address"] || row["住址"]),
                            volunteerId: cleanValue(row["深圳义工号"] || row["volunteerId"]),
                            wechat: cleanValue(row["微信号"] || row["wechat"]),
                            dharmaName: cleanValue(row["法名"] || row["dharmaName"]),
                            education,
                            religiousBackground,
                            refugeStatus,
                            healthConditions,
                            emergencyContact: cleanValue(row["紧急联系人"] || row["emergencyContact"]),
                            emergencyPhone: cleanValue(row["紧急联系电话"] || row["emergencyPhone"]),
                        };

                        // 只添加有值的字段
                        Object.entries(optionalFields).forEach(([key, value]) => {
                            if (value !== undefined) {
                                data[key] = value;
                            }
                        });

                        return data;
                    });

                    console.log("映射后数据:", mappedData);
                    document.getElementById('output').textContent = JSON.stringify(mappedData, null, 2);
                } catch (error) {
                    console.error("解析失败:", error);
                    document.getElementById('output').textContent = "解析失败: " + error.message;
                }
            };
            reader.readAsBinaryString(file);
        });
    </script>
</body>
</html>
