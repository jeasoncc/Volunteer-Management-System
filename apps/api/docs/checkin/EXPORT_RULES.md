# 志愿者服务时间统计表导出规则

## 📁 文件管理

### 导出文件夹
所有导出的 Excel 文件统一保存在 `exports/` 文件夹中。

### .gitignore 配置
```gitignore
# Exports
/exports/
*.xlsx
```

导出文件不会被提交到 Git 仓库。

---

## ⏰ 工时计算规则

### 规则1：单次打卡
```
只有一次打卡记录
→ 签到时间 = 打卡时间
→ 签退时间 = 打卡时间 + 1 小时
→ 服务时长 = 1 小时

示例：
12:05 打卡 → 签到 12:05，签退 13:05，时长 1 小时 ✅
```

**修改原因：** 避免签到和签退时间相同，符合实际服务场景。

### 规则2：多次打卡
```
有两次及以上打卡记录
→ 签到时间 = 第一次打卡时间
→ 签退时间 = 最后一次打卡时间
→ 服务时长 = 签退时间 - 签到时间

示例：
10:00 打卡，14:30 打卡 → 签到 10:00，签退 14:30，时长 4.5 小时
```

### 规则3：跨天打卡
```
场景：23:00 打卡，次日 01:00 打卡
→ 判断：签退时间 < 签到时间
→ 处理：签退时间 + 24小时
→ 服务时长 = (01:00 + 24h) - 23:00 = 2小时

示例：
23:30 打卡，01:15 打卡 → 签到 23:30，签退 01:15，时长 1.8 小时
```

### 规则4：最大工时限制 ⭐
```
如果计算出的工时 > 8小时
→ 限制为 8小时

示例：
00:55 打卡，17:33 打卡 → 计算 16.6 小时 → 限制为 8 小时 ✅
```

**修改原因：** 每天义工的服务时长最长只能 8 个小时。

---

## 📊 实际验证数据

### 单次打卡验证
```
房石安 | 2025-09-10 | 17:57 | 18:57 | 1 小时 ✅
房石安 | 2025-09-11 | 17:17 | 18:17 | 1 小时 ✅
房石安 | 2025-09-13 | 12:05 | 13:05 | 1 小时 ✅
```

### 最大工时限制验证
```
王成山 | 2025-11-09 | 00:59 - 17:36 | 实际 16.6 小时 → 限制为 8 小时 ✅
王成山 | 2025-11-10 | 00:55 - 17:33 | 实际 16.6 小时 → 限制为 8 小时 ✅
刘永姐 | 2025-11-12 | 05:52 - 20:08 | 实际 14.3 小时 → 限制为 8 小时 ✅
```

### 统计数据（2025年11月）
- **志愿者人数**: 25 人
- **数据行数**: 157 行
- **总服务时长**: 648.2 小时（限制后）
- **原始总时长**: 767.2 小时（限制前）
- **被限制的记录**: 41 条（26.1%）

---

## 🎯 使用示例

### 导出当前月份所有人的数据
```bash
curl 'http://localhost:3001/api/v1/export/volunteer-service?startDate=2025-11-01&endDate=2025-11-30' \
  -o exports/志愿者服务时间统计表_2025年11月.xlsx
```

### 导出指定用户
```bash
curl 'http://localhost:3001/api/v1/export/volunteer-service?startDate=2025-11-01&endDate=2025-11-30&lotusIds=LZ-V-6020135' \
  -o exports/陈璋_11月服务记录.xlsx
```

### 自定义活动名称
```bash
curl 'http://localhost:3001/api/v1/export/volunteer-service?startDate=2025-11-01&endDate=2025-11-30&activityName=助念服务' \
  -o exports/助念服务_11月统计.xlsx
```

---

## 🧪 测试脚本

### 运行完整测试
```bash
bash scripts/test/test-export.sh
```

### 验证导出文件
```bash
# 基本验证
bun run scripts/verify-export.ts

# 详细统计
bun run scripts/verify-export-detailed.ts

# 验证最大工时限制
bun run scripts/verify-max-hours.ts
```

---

## 📝 修改记录

### 2024-11-16
1. ✅ 创建 `exports/` 文件夹统一管理导出文件
2. ✅ 添加 `.gitignore` 规则忽略导出文件
3. ✅ 修改最大工时限制：从 12 小时改为 8 小时
4. ✅ 修改单次打卡规则：签退时间 = 签到时间 + 1 小时（而不是相同时间）
5. ✅ 更新所有测试脚本使用 `exports/` 文件夹

---

## ✅ 总结

### 已实现功能
- ✅ 符合深圳志愿者管理系统格式
- ✅ 使用正确的志愿者系统义工号（volunteer_id）
- ✅ Excel 两行表头，指定字段标红
- ✅ 自动计算工时（支持跨天）
- ✅ 单次打卡自动添加 1 小时假时长
- ✅ 最大工时限制为 8 小时
- ✅ 导出文件统一管理在 exports/ 文件夹
- ✅ 支持日期范围筛选
- ✅ 支持指定用户导出
- ✅ 支持自定义活动名称

### 工时规则
- 单次打卡：1 小时（签退 = 签到 + 1小时）
- 多次打卡：实际时长（签退 - 签到）
- 跨天打卡：自动处理
- 最大限制：8 小时/天

🎉 **导出功能完全就绪，可直接用于上传深圳志愿者管理系统！**
