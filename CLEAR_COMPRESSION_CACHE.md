# æ¸…é™¤å‹ç¼©ç¼“å­˜

## é—®é¢˜

ä¿®æ”¹äº†å‹ç¼©é…ç½®ï¼Œä½†æ˜¯å‹ç¼©æ•ˆæœæ²¡å˜åŒ–ï¼Œè¿˜æ˜¯ 20-40KBã€‚

**åŸå› ï¼š** ä»£ç ä½¿ç”¨äº†ç¼“å­˜çš„ç¼©ç•¥å›¾ï¼Œä¸ä¼šé‡æ–°å‹ç¼©ã€‚

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šåˆ é™¤ç¼©ç•¥å›¾ç¼“å­˜ï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /path/to/lianhuazhai-monorepo

# åˆ é™¤æ‰€æœ‰ç¼©ç•¥å›¾ç¼“å­˜
rm -rf public/upload/avatar/thumbnails/*

# æˆ–è€…åªåˆ é™¤ thumb_ å¼€å¤´çš„æ–‡ä»¶
rm -f public/upload/avatar/thumbnails/thumb_*
```

### æ–¹æ¡ˆ2ï¼šé‡å¯ API æœåŠ¡ï¼ˆå¿…é¡»ï¼‰

å³ä½¿åˆ é™¤äº†ç¼“å­˜ï¼Œä¹Ÿéœ€è¦é‡å¯ API æœåŠ¡è®©æ–°é…ç½®ç”Ÿæ•ˆï¼š

```bash
# åœæ­¢ API æœåŠ¡
# ç„¶åé‡æ–°å¯åŠ¨
```

### æ–¹æ¡ˆ3ï¼šä½¿ç”¨"ä¸å‹ç¼©é‡è¯•"ï¼ˆæµ‹è¯•ç”¨ï¼‰

å¯¹äºå¤±è´¥çš„ç”¨æˆ·ï¼Œå¯ä»¥ä½¿ç”¨"ä¸å‹ç¼©ä¸‹å‘"åŠŸèƒ½ï¼Œè¿™ä¼šä½¿ç”¨åŸå§‹ç…§ç‰‡ï¼Œä¸ç»è¿‡å‹ç¼©ã€‚

## å®Œæ•´æ­¥éª¤

1. **åˆ é™¤ç¼“å­˜**
   ```bash
   rm -rf public/upload/avatar/thumbnails/*
   ```

2. **é‡å¯ API æœåŠ¡**
   - åœæ­¢æœåŠ¡
   - é‡æ–°å¯åŠ¨

3. **ä¿®æ”¹å‹ç¼©é…ç½®**
   - æ‰“å¼€è®¾å¤‡åŒæ­¥é¡µé¢
   - ç‚¹å‡»"ä¿®æ”¹é…ç½®"
   - é€‰æ‹©"é«˜è´¨é‡ï¼ˆæ¨èï¼‰"é¢„è®¾
   - ç‚¹å‡»"ä¿å­˜é…ç½®"

4. **æµ‹è¯•åŒæ­¥**
   - åŒæ­¥å‡ ä¸ªç”¨æˆ·
   - è§‚å¯Ÿæ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
     ```
     ğŸ“¸ åˆ˜å®‹å¹³: 1822.9KB å‹ç¼©è‡³ 650KB âœ…å·²å‹ç¼©
     ```
     è€Œä¸æ˜¯ï¼š
     ```
     ğŸ“¸ åˆ˜å®‹å¹³: 1822.9KB -> 35.1KB âœ…å·²å‹ç¼©
     ```

## éªŒè¯æ˜¯å¦ç”Ÿæ•ˆ

### æ£€æŸ¥æ—¥å¿—

**æ—§é…ç½®ï¼ˆæ²¡ç”Ÿæ•ˆï¼‰ï¼š**
```
ğŸ“¸ åˆ˜å®‹å¹³: 1822.9KB -> 35.1KB âœ…å·²å‹ç¼©  â† å‹ç¼©åˆ° 35KBï¼Œå¤ªå°
ğŸ“¸ é»„é›…æ–‡: 2082.6KB -> 24.4KB âœ…å·²å‹ç¼©  â† å‹ç¼©åˆ° 24KBï¼Œå¤ªå°
```

**æ–°é…ç½®ï¼ˆå·²ç”Ÿæ•ˆï¼‰ï¼š**
```
ğŸ“¸ åˆ˜å®‹å¹³: 1822.9KB å‹ç¼©è‡³ 650KB âœ…å·²å‹ç¼©  â† å‹ç¼©åˆ° 650KBï¼Œåˆç†
ğŸ“¸ é»„é›…æ–‡: 2082.6KB å‹ç¼©è‡³ 750KB âœ…å·²å‹ç¼©  â† å‹ç¼©åˆ° 750KBï¼Œåˆç†
```

### æ£€æŸ¥æˆåŠŸç‡

- **æ—§é…ç½®**ï¼š8ä¸ªå¤±è´¥ï¼ˆå‹ç¼©å¤ªç‹ ï¼‰
- **æ–°é…ç½®**ï¼šåº”è¯¥åªæœ‰ 0-2ä¸ªå¤±è´¥

## ä¸ºä»€ä¹ˆä¼šæœ‰ç¼“å­˜ï¼Ÿ

### ç¼“å­˜é€»è¾‘

ä»£ç ä¸­æœ‰è¿™æ ·çš„é€»è¾‘ï¼š

```typescript
// å¦‚æœç¼©ç•¥å›¾å·²å­˜åœ¨ä¸”è¾ƒæ–°ï¼Œç›´æ¥è¿”å›
if (existsSync(thumbnailPath)) {
  const originalStats = statSync(fullPath)
  const thumbStats = statSync(thumbnailPath)
  
  if (thumbStats.mtime >= originalStats.mtime) {
    logger.info(`ğŸ“¦ ä½¿ç”¨å·²æœ‰ç¼©ç•¥å›¾: ${thumbnailUrlPath}`)
    return { ... } // ç›´æ¥è¿”å›ç¼“å­˜
  }
}
```

### ç¼“å­˜çš„å¥½å¤„

- é¿å…é‡å¤å‹ç¼©ï¼Œæé«˜æ€§èƒ½
- å‡å°‘ CPU å’Œç£ç›˜ I/O

### ç¼“å­˜çš„é—®é¢˜

- ä¿®æ”¹å‹ç¼©é…ç½®åï¼Œä¸ä¼šè‡ªåŠ¨é‡æ–°å‹ç¼©
- éœ€è¦æ‰‹åŠ¨åˆ é™¤ç¼“å­˜

## è‡ªåŠ¨æ¸…é™¤ç¼“å­˜ï¼ˆæœªæ¥æ”¹è¿›ï¼‰

å¯ä»¥åœ¨æ›´æ–°é…ç½®æ—¶è‡ªåŠ¨æ¸…é™¤ç¼“å­˜ï¼š

```typescript
// æ›´æ–°é…ç½®æ—¶
app.post('/compression/config', async ({ body }) => {
  // ... æ›´æ–°é…ç½® ...
  
  // æ¸…é™¤ç¼©ç•¥å›¾ç¼“å­˜
  const thumbnailDir = join(process.cwd(), 'public/upload/avatar/thumbnails')
  if (existsSync(thumbnailDir)) {
    const files = readdirSync(thumbnailDir)
    for (const file of files) {
      if (file.startsWith('thumb_')) {
        unlinkSync(join(thumbnailDir, file))
      }
    }
    logger.info('âœ… å·²æ¸…é™¤ç¼©ç•¥å›¾ç¼“å­˜')
  }
  
  return { success: true, message: 'é…ç½®å·²æ›´æ–°ï¼Œç¼“å­˜å·²æ¸…é™¤' }
})
```

## æ€»ç»“

**å½“å‰é—®é¢˜ï¼š** å‹ç¼©é…ç½®æ²¡ç”Ÿæ•ˆï¼Œå› ä¸ºä½¿ç”¨äº†ç¼“å­˜

**è§£å†³æ–¹æ³•ï¼š**
1. åˆ é™¤ç¼“å­˜ï¼š`rm -rf public/upload/avatar/thumbnails/*`
2. é‡å¯æœåŠ¡
3. é‡æ–°åŒæ­¥

**é¢„æœŸæ•ˆæœï¼š** 1.5-2MB ç…§ç‰‡å‹ç¼©åˆ° 600-800KBï¼Œè€Œä¸æ˜¯ 20-40KB
