# 满勤档位功能

## 功能说明

为满勤配置添加了档位选择（1-6档），不同档位对应不同的工时要求。

## 档位配置

| 档位 | 时长 | 签到时间 | 签退时间 | 说明 |
|------|------|---------|---------|------|
| 1档 | 2小时 | 09:00 | 11:00 | 最低标准 |
| 2档 | 4小时 | 09:00 | 13:00 | 半天 |
| 3档 | 6小时 | 09:00 | 15:00 | 大半天 |
| 4档 | 8小时 | 09:00 | 17:00 | 标准工作日 |
| 5档 | 10小时 | 08:00 | 18:00 | 加班 |
| 6档 | 12小时 | 08:00 | 20:00 | 全天（默认） |

## 使用方法

### 1. 编辑义工
1. 打开义工编辑弹窗
2. 勾选"满勤配置"
3. 选择档位（1-6档）
4. 保存

### 2. 查看档位
在义工管理表格中，满勤列会显示：
- **满勤 3档** - 表示该义工使用3档（6小时）

### 3. 导出考勤
导出考勤报表时，系统会根据每个义工的档位自动生成对应时长的满勤记录。

例如：
- 李广亭设置为3档 → 导出时每天自动填充 09:00-15:00（6小时）
- 张三设置为6档 → 导出时每天自动填充 08:00-20:00（12小时）

## 界面改进

### 1. 满勤显示
- **之前**：满勤 3档 (6h)
- **现在**：满勤 3档

### 2. 深圳义工号
- **之前**：纯文本显示
- **现在**：Badge 样式，点击复制

## 数据库变更

已添加字段：
```sql
ALTER TABLE volunteer 
ADD COLUMN attendance_tier INT DEFAULT 6 
COMMENT '满勤档位：1-6档，默认6档（12小时）';
```

已更新现有数据：
- 9个满勤义工的档位已设置为6档（保持向后兼容）

## 代码变更

### 后端
1. `apps/api/src/db/schema.ts` - 添加 `attendanceTier` 字段
2. `apps/api/src/config/attendance.ts` - 档位配置文件
3. `apps/api/src/modules/volunteer/model.ts` - 添加档位到 DTO
4. `apps/api/src/modules/volunteer/utils/mapToUpdateData.ts` - 更新映射
5. `apps/api/src/modules/checkin/export.service.ts` - 根据档位生成满勤记录

### 前端
1. `apps/web/src/components/VolunteerForm.tsx` - 添加档位选择下拉菜单
2. `apps/web/src/components/VolunteerDataTable.tsx` - 显示档位和优化义工号

## 测试步骤

1. **编辑义工**
   - 打开李广亭的编辑弹窗
   - 勾选满勤配置
   - 选择3档
   - 保存

2. **验证保存**
   ```sql
   SELECT name, lotus_id, require_full_attendance, attendance_tier 
   FROM volunteer 
   WHERE name = '李广亭';
   ```
   应该看到 `attendance_tier = 3`

3. **导出测试**
   - 导出包含李广亭的考勤报表
   - 检查她的满勤记录是否为 09:00-15:00（6小时）

## 注意事项

1. **默认档位**：新勾选满勤的义工默认为6档（12小时）
2. **向后兼容**：已有的满勤义工自动设置为6档
3. **档位范围**：只能选择1-6档，超出范围会报错
4. **导出影响**：档位只影响导出时的满勤记录，不影响实际打卡

## 故障排查

### 问题：修改档位后导出还是12小时

**原因**：可能是缓存或前端没有正确提交

**解决**：
1. 检查数据库中的 `attendance_tier` 值
2. 重启 API 服务
3. 清除浏览器缓存
4. 重新编辑并保存

### 问题：编辑时看不到档位选择

**原因**：没有勾选满勤配置

**解决**：先勾选"满勤配置"，档位选择会自动显示
